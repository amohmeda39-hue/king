<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KingBad Stats ğŸ‘‘ğŸ¤¡</title>
<style>
*,:after,:before{box-sizing:border-box;margin:0;padding:0}body{font-family:Tahoma,sans-serif;background:#020617;color:#fff;padding:20px;direction:rtl;margin:0;overflow-x:hidden}.card{background:#0f172a;padding:15px;border-radius:10px;border:1px solid #1e293b;max-width:600px;margin:20px auto;box-shadow:0 4px 6px rgba(0,0,0,.3)}h1,h2,h3,h4{color:#e2e8f0;margin-top:0}h1{text-align:center;color:#fbbf24;margin-bottom:20px}input,select,button{width:100%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #334155;font-size:14px;box-sizing:border-box}input,select{background:#1e293b;color:#e2e8f0}button{background:#22c55e;color:#fff;font-weight:bold;cursor:pointer;border:none;transition:background .3s}button:hover{background:#16a34a}button.secondary{background:#3b82f6}button.secondary:hover{background:#2563eb}button.danger{background:#ef4444}button.danger:hover{background:#dc2626}button.admin{background:#8b5cf6}button.admin:hover{background:#7c3aed}.app{display:none}#loginMsg{text-align:center;margin-top:10px;color:#ef4444;font-size:14px}#individualBox,#teamBox{margin-top:15px}#individuals input,#teams input{margin:5px 0}#teams div{display:flex;gap:10px;margin:5px 0}#teams div input{flex:1}.stats-buttons{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}.stats-buttons button{flex:1;min-width:80px}#statsBox,#compareResult,#competitionsHistory{margin-top:15px;padding:15px;background:#1e293b;border-radius:8px;min-height:50px}.competition-item{background:#1e293b;margin:10px 0;padding:12px;border-radius:8px;border-right:4px solid #22c55e;transition:all .3s;position:relative}.competition-item:hover{background:#334155;transform:translateX(-5px)}.user-badge{display:inline-block;background:#3b82f6;color:#fff;padding:2px 10px;border-radius:12px;font-size:.85em;margin:0 5px}.time-badge{display:inline-block;background:#10b981;color:#fff;padding:2px 10px;border-radius:12px;font-size:.85em;margin:0 5px}.admin-badge{display:inline-block;background:#8b5cf6;color:#fff;padding:2px 10px;border-radius:12px;font-size:.85em;margin:0 5px}.info-text{color:#94a3b8;font-size:.9em;margin-top:5px}.current-user{position:fixed;top:20px;left:20px;background:#1e293b;padding:8px 15px;border-radius:20px;font-size:.9em;border:1px solid #334155;z-index:1000}.logout-btn{position:fixed;top:20px;right:20px;background:#ef4444;color:#fff;padding:8px 15px;border-radius:20px;border:none;cursor:pointer;font-size:.9em;z-index:1000}.logout-btn:hover{background:#dc2626}.admin-panel{position:fixed;top:60px;right:20px;background:#1e293b;padding:15px;border-radius:10px;border:2px solid #8b5cf6;z-index:1000;width:300px;display:none}.delete-btn{position:absolute;top:5px;left:5px;background:#ef4444;color:#fff;border:none;border-radius:50%;width:25px;height:25px;cursor:pointer;font-size:12px;display:none}.delete-btn:hover{background:#dc2626}.admin-visible .delete-btn{display:block}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:2000;align-items:center;justify-content:center}.modal-content{background:#0f172a;padding:20px;border-radius:10px;max-width:500px;width:90%;border:2px solid #8b5cf6}.modal-buttons{display:flex;gap:10px;margin-top:20px}.player-management{display:grid;grid-template-columns:1fr 1fr;gap:10px}.toggle-btns{position:fixed;top:60px;right:20px;z-index:1000;display:flex;gap:5px}.sync-status{position:fixed;bottom:20px;right:20px;background:#1e293b;padding:8px 15px;border-radius:20px;font-size:.9em;border:1px solid #334155;z-index:1000}.online{color:#22c55e}.offline{color:#ef4444}.syncing{color:#fbbf24}.saving{color:#fbbf24}.loading{color:#3b82f6}.error{color:#ef4444}.toast{position:fixed;bottom:80px;right:20px;background:#0f172a;padding:12px 20px;border-radius:8px;border-left:4px solid #22c55e;box-shadow:0 4px 12px rgba(0,0,0,.4);z-index:2000;max-width:400px;display:none}.toast.error{border-left-color:#ef4444}.toast.warning{border-left-color:#fbbf24}.toast.info{border-left-color:#3b82f6}.progress-bar{height:6px;background:#334155;border-radius:3px;overflow:hidden;margin:10px 0}.progress{height:100%;background:#22c55e;transition:width .3s}.stats-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #334155}.stats-row:last-child{border-bottom:none}.rate-badge{display:inline-block;background:#8b5cf6;color:#fff;padding:2px 8px;border-radius:10px;font-size:.8em}@media (max-width:768px){body{padding:10px}.card{max-width:100%;margin:10px 0;padding:12px}.current-user,.logout-btn,.admin-panel,.toggle-btns,.sync-status{position:static;margin:10px;display:block;width:auto}#teams div{flex-direction:column;gap:5px}.stats-buttons{flex-direction:column}.player-management{grid-template-columns:1fr}.toast{right:10px;left:10px;bottom:100px}}
</style>
</head>
<body>

<!-- Toast Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
<div id="toast" class="toast"></div>

<!-- Ù†ÙˆØ§ÙØ° Ø§Ù„ØªØ£ÙƒÙŠØ¯ -->
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</h3>
        <p id="modalMessage">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ</p>
        <div class="modal-buttons">
            <button onclick="confirmAction(true)" class="danger">Ù†Ø¹Ù…</button>
            <button onclick="confirmAction(false)">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
<div id="currentUserInfo" class="current-user" style="display: none;">
    <span id="currentUserName"></span>
    <span id="currentUserRole" class="admin-badge" style="display: none;">Ø£Ø¯Ù…Ù†</span>
</div>

<!-- Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© -->
<div id="syncStatus" class="sync-status" style="display: none;">
    <span id="syncStatusText">ğŸ”µ Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
</div>

<!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
<div class="toggle-btns">
    <button id="adminToggleBtn" class="admin" onclick="toggleAdminPanel()" style="display: none;">âš™ï¸ Ø£Ø¯Ù…Ù†</button>
    <button id="syncBtn" class="secondary" onclick="loadCompetitions()" style="display: none;">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
</div>

<!-- Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† -->
<div id="adminPanel" class="admin-panel">
    <h3 style="color: #8b5cf6; margin-top: 0;">ğŸ‘‘ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†</h3>
    <div style="display: grid; gap: 10px;">
        <button onclick="toggleDeleteMode()" class="admin">ğŸ—‘ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø°Ù</button>
        <button onclick="exportCSV()" class="admin">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
        <button onclick="showPlayersManagement()" class="admin">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</button>
        <button onclick="showUsersManagement()" class="admin">ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
        <button onclick="resetAllData()" class="danger">ğŸ”¥ ØªØµÙÙŠØ± Ø§Ù„ÙƒÙ„</button>
        <button onclick="showSyncStats()" class="secondary">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</button>
    </div>
</div>

<button id="logoutBtn" class="logout-btn" onclick="logout()" style="display: none;">ğŸšª Ø®Ø±ÙˆØ¬</button>

<!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div class="card" id="loginBox">
    <h2>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <div style="text-align: center; margin-bottom: 15px;">
        <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #22c55e, #3b82f6); border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 30px;">
            ğŸ‘‘
        </div>
    </div>
    <input id="user" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" autocomplete="off">
    <input id="pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="off">
    <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
    <div id="loginMsg"></div>
    <div class="info-text" style="text-align: center; margin-top: 15px;">
        KingBad Stats v3.0 ğŸ‘‘ğŸ¤¡<br>
        Ù†Ø¸Ø§Ù… Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù… Ù…Ø¹ ØªØ®Ø²ÙŠÙ† Ø³Ø­Ø§Ø¨ÙŠ Ø¨Ø­Øª
    </div>
</div>

<!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<div class="app" id="appBox">
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1 style="margin: 0;">ğŸ‘‘ğŸ¤¡ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙƒÙ†Ø¬ ÙˆØ§Ù„Ø¨Ø¹Ø±ÙˆØ±</h1>
        <div id="appStats" style="font-size: 0.9em; color: #94a3b8;">
            <span id="totalCompetitions">0</span> Ø¯ÙˆØ±ÙŠ | <span id="totalPlayers">0</span> Ù„Ø§Ø¹Ø¨
        </div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ù„Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ -->
    <datalist id="playersDatalist"></datalist>

    <!-- Ù‚Ø³Ù… Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±ÙŠ -->
    <div class="card">
        <h3>â• Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±ÙŠ Ø¬Ø¯ÙŠØ¯</h3>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <select id="type" onchange="switchMode()" style="flex: 1;">
                <option value="individual">ğŸ® ÙØ±Ø¯ÙŠ</option>
                <option value="team">ğŸ‘¥ Ø«Ù†Ø§Ø¦ÙŠ</option>
            </select>
            <button onclick="quickAddPlayers()" class="secondary" style="width: auto;">âš¡ Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø©</button>
        </div>

        <div id="individualBox">
            <div id="individuals"></div>
            <button onclick="addIndividual()">â• Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨</button>
        </div>

        <div id="teamBox" style="display:none">
            <div id="teams"></div>
            <button onclick="addTeam()">â• Ø¥Ø¶Ø§ÙØ© ÙØ±ÙŠÙ‚</button>
        </div>

        <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button id="saveButton" onclick="saveCompetition()" style="flex: 3;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±ÙŠ</button>
            <button onclick="clearForm()" class="secondary" style="flex: 1;">ğŸ—‘ï¸ Ù…Ø³Ø­</button>
        </div>
        <div class="info-text">
            ğŸ“… Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
        </div>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div class="card">
        <h3>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
        <div class="stats-buttons">
            <button onclick="toggleStats('individual')">ğŸ® ÙØ±Ø¯ÙŠ</button>
            <button onclick="toggleStats('team')">ğŸ‘¥ Ø«Ù†Ø§Ø¦ÙŠ</button>
            <button onclick="toggleStats('all')">ğŸ“ˆ Ø¹Ø§Ù…</button>
            <button onclick="showMyStats()" class="secondary">ğŸ‘¤ Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙŠ</button>
            <button onclick="showTopPlayers()" class="secondary">ğŸ† Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</button>
            <button onclick="showHistory()" class="secondary">ğŸ“œ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙƒØ§Ù…Ù„</button>
        </div>
        <div id="statsBox">
            <p style="text-align: center; color: #94a3b8;">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</p>
        </div>
    </div>

    <!-- Ù‚Ø³Ù… Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† -->
    <div class="card">
        <h3>ğŸ†š Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h3>
        <div class="player-management">
            <select id="playerA">
                <option value="">ğŸ‘¤ Ø§Ø®ØªØ± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„</option>
            </select>
            <select id="playerB">
                <option value="">ğŸ‘¤ Ø§Ø®ØªØ± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
            </select>
        </div>
        <select id="compareElement">
            <option value="total">ğŸ® Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª</option>
            <option value="king">ğŸ‘‘ Ø§Ù„ÙƒÙ†Ø¬</option>
            <option value="bad">ğŸ¤¡ Ø§Ù„Ø¨Ø¹Ø±ÙˆØ±</option>
            <option value="winRate">ğŸ“Š Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ²</option>
            <option value="kingRate">ğŸ‘‘ Ù†Ø³Ø¨Ø© Ø§Ù„ÙƒÙ†Ø¬</option>
            <option value="badRate">ğŸ¤¡ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¨Ø¹Ø±ÙˆØ±</option>
        </select>
        <button onclick="toggleCompare()">Ù…Ù‚Ø§Ø±Ù†Ø©</button>
        <div id="compareResult"></div>
    </div>

    <!-- Ù‚Ø³Ù… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª -->
    <div class="card">
        <h3>ğŸ“‹ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ©</h3>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div class="info-text">Ø¢Ø®Ø± 15 Ø¯ÙˆØ±ÙŠØ© Ù…Ø¶Ø§ÙØ©</div>
            <button onclick="loadCompetitions()" class="secondary" style="width: auto;">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
        </div>
        <div id="competitionsHistory">
            <p style="text-align: center; color: #94a3b8;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª...</p>
        </div>
    </div>

    <!-- ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø© -->
    <div style="text-align: center; margin-top: 30px; color: #64748b; font-size: 0.9em;">
        <hr style="border-color: #334155; margin: 20px 0;">
        <div>KingBad Stats v3.0 ğŸ‘‘ğŸ¤¡ | ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø¹Ø¨Ø¯Ù„ÙŠ</div>
        <div style="margin-top: 5px;">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2024 | ØªØ®Ø²ÙŠÙ† Ø³Ø­Ø§Ø¨ÙŠ Ø¨Ø­Øª</div>
    </div>
</div>

<script>
// ==================== Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ ÙÙ‚Ø· ====================
// Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
localStorage.clear();

// ==================== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ====================
let USERS = [
    {u:"player1",p:"1234",n:"Ø§Ù„Ù„Ø§Ø¹Ø¨ 1",r:"user"},
    {u:"player2",p:"1234",n:"Ø§Ù„Ù„Ø§Ø¹Ø¨ 2",r:"user"},
    {u:"player3",p:"1234",n:"Ø§Ù„Ù„Ø§Ø¹Ø¨ 3",r:"user"},
    {u:"alabdle",p:"admin123",n:"Ø§Ù„Ø¹Ø¨Ø¯Ù„ÙŠ",r:"admin"}
];

window.competitions = [];
window.allPlayers = new Set();
window.currentUser = null;
window.deleteMode = false;
window.pendingAction = null;
window.isOnline = navigator.onLine;
window.firebaseEnabled = true;
window.isSaving = false;

// ==================== Ø¯Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ====================
function showToast(message, type = 'info', duration = 3000) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast ${type}`;
    toast.style.display = 'block';
    
    setTimeout(() => {
        toast.style.display = 'none';
    }, duration);
}

function updateSaveButtonState(isSaving) {
    const saveButton = document.getElementById('saveButton');
    if (isSaving) {
        saveButton.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
        saveButton.disabled = true;
        saveButton.style.opacity = '0.7';
        saveButton.style.cursor = 'not-allowed';
    } else {
        saveButton.innerHTML = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±ÙŠ';
        saveButton.disabled = false;
        saveButton.style.opacity = '1';
        saveButton.style.cursor = 'pointer';
    }
}

function updateSyncStatus(text, status) {
    const statusElement = document.getElementById('syncStatus');
    const textElement = document.getElementById('syncStatusText');
    
    if (statusElement && textElement) {
        statusElement.style.display = 'block';
        textElement.textContent = text;
        textElement.className = status;
        window.isOnline = status === "online" || status === "syncing";
    }
}

// ==================== Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ÙÙ‚Ø· ====================
window.deleteCompetition = async function(firebaseId) {
    if (!currentUser || currentUser.role !== "admin") {
        showToast("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø­Ø°Ù", "error");
        return;
    }
    
    showConfirmModal("ğŸ—‘ï¸ Ø­Ø°Ù Ø¯ÙˆØ±ÙŠ", 
        "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ±ÙŠØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.", 
        async () => {
            try {
                if (!window.isOnline) {
                    showToast("âŒ ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª", "error");
                    return;
                }
                
                updateSyncStatus("ğŸ—‘ï¸ Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±ÙŠ...", "syncing");
                
                // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
                const response = await fetch(
                    `https://firestore.googleapis.com/v1/projects/winner-71276/databases/(default)/documents/competitions/${firebaseId}`,
                    { 
                        method: 'DELETE',
                        signal: AbortSignal.timeout(8000)
                    }
                );
                
                if (response.ok) {
                    // Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                    window.competitions = window.competitions.filter(c => c.firebaseId !== firebaseId);
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                    updateAppStats();
                    displayCompetitionsHistory();
                    updatePlayersLists();
                    
                    updateSyncStatus("âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­", "online");
                    showToast("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±ÙŠ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©");
                    
                } else {
                    throw new Error('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±ÙŠ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©');
                }
                
            } catch (error) {
                console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±ÙŠ:", error);
                updateSyncStatus("âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù", "error");
                showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±ÙŠ", "error");
            }
        }
    );
};

// ==================== Ø¯Ø§Ù„Ø© ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø°Ù ====================
window.toggleDeleteMode = function() {
    if (!currentUser || currentUser.role !== "admin") {
        showToast("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„", "error");
        return;
    }
    
    deleteMode = !deleteMode;
    
    // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø°Ù
    const items = document.querySelectorAll('.competition-item');
    items.forEach(item => {
        if (deleteMode) {
            item.classList.add('admin-visible');
        } else {
            item.classList.remove('admin-visible');
        }
    });
    
    showToast(deleteMode ? "âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø°Ù" : "âŒ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø°Ù");
};

// ==================== Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ====================
async function loadFromCloud() {
    if (!window.firebaseEnabled) {
        console.log("âš ï¸ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ù…Ø¹Ø·Ù„Ø©");
        return null;
    }
    
    if (!window.isOnline) {
        updateSyncStatus("ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª", "offline");
        showToast("âš ï¸ ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª", "warning");
        return null;
    }
    
    try {
        updateSyncStatus("ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...", "syncing");
        
        const response = await fetch(
            "https://firestore.googleapis.com/v1/projects/winner-71276/databases/(default)/documents/competitions",
            { 
                headers: { 'Accept': 'application/json' },
                signal: AbortSignal.timeout(10000)
            }
        );
        
        if (response.ok) {
            const data = await response.json();
            const cloudCompetitions = [];
            
            if (data.documents) {
                data.documents.forEach(doc => {
                    const fields = doc.fields;
                    cloudCompetitions.push({
                        firebaseId: doc.name.split('/').pop(),
                        players: fields.players?.arrayValue?.values?.map(v => v.stringValue) || [],
                        addedBy: fields.addedBy?.stringValue || "Ù…Ø¬Ù‡ÙˆÙ„",
                        addedByName: fields.addedByName?.stringValue || "Ù…Ø¬Ù‡ÙˆÙ„",
                        timestamp: fields.timestamp?.stringValue || new Date().toISOString(),
                        date: fields.date?.stringValue || new Date().toLocaleDateString('ar-SA'),
                        time: fields.time?.stringValue || new Date().toLocaleTimeString('ar-SA'),
                        dateTime: fields.dateTime?.stringValue || new Date().toLocaleString('ar-SA')
                    });
                });
            }
            
            // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
            cloudCompetitions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${cloudCompetitions.length} Ø¯ÙˆØ±ÙŠ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©`);
            updateSyncStatus("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "online");
            return { competitions: cloudCompetitions };
            
        } else {
            throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©');
        }
    } catch (error) {
        console.error("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©:", error);
        updateSyncStatus("ğŸ”´ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„", "error");
        showToast("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©", "error");
        return null;
    }
}

// ==================== Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ÙÙ‚Ø· ====================
async function saveToCloud(competitionData) {
    if (!window.firebaseEnabled || !window.isOnline) {
        showToast("âŒ ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª", "error");
        return null;
    }
    
    try {
        const firestoreData = {
            fields: {
                players: {
                    arrayValue: {
                        values: competitionData.players.map(player => ({ stringValue: player }))
                    }
                },
                addedBy: { stringValue: competitionData.addedBy },
                addedByName: { stringValue: competitionData.addedByName },
                timestamp: { stringValue: competitionData.timestamp },
                date: { stringValue: competitionData.date },
                time: { stringValue: competitionData.time },
                dateTime: { stringValue: competitionData.dateTime }
            }
        };
        
        const response = await fetch(
            "https://firestore.googleapis.com/v1/projects/winner-71276/databases/(default)/documents/competitions",
            {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(firestoreData),
                signal: AbortSignal.timeout(8000)
            }
        );
        
        if (response.ok) {
            const data = await response.json();
            competitionData.firebaseId = data.name.split('/').pop();
            
            // Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            window.competitions.unshift(competitionData);
            
            console.log("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±ÙŠ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©");
            return competitionData.firebaseId;
            
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©');
        }
    } catch (error) {
        console.error("âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©:", error);
        throw error;
    }
}

// ==================== Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ====================
window.login = function() {
    const username = document.getElementById('user').value;
    const password = document.getElementById('pass').value;
    
    if (!username || !password) {
        document.getElementById('loginMsg').textContent = "âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±";
        return;
    }
    
    const user = USERS.find(u => u.u === username && u.p === password);
    
    if (user) {
        currentUser = {
            username: user.u,
            name: user.n,
            role: user.r,
            loginTime: new Date().toLocaleString('ar-SA')
        };
        
        updateUserInterface();
        document.getElementById('loginBox').style.display = "none";
        document.getElementById('appBox').style.display = "block";
        loadCompetitions();
        document.getElementById('loginMsg').textContent = "";
        
        // Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙÙ‚Ø· (Ù„ÙŠØ³ Ù…Ø­Ù„ÙŠØ§Ù‹)
        window.sessionUser = currentUser;
        
    } else {
        document.getElementById('loginMsg').textContent = "âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
    }
};

window.logout = function() {
    showConfirmModal("ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬", "Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ", () => {
        currentUser = null;
        deleteMode = false;
        window.sessionUser = null;
        document.getElementById('appBox').style.display = "none";
        document.getElementById('loginBox').style.display = "block";
        document.getElementById('currentUserInfo').style.display = "none";
        document.getElementById('logoutBtn').style.display = "none";
        document.getElementById('adminToggleBtn').style.display = "none";
        document.getElementById('syncBtn').style.display = "none";
        document.getElementById('adminPanel').style.display = "none";
        document.getElementById('syncStatus').style.display = "none";
        document.getElementById('user').value = "";
        document.getElementById('pass').value = "";
        showToast("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­");
    });
};

function updateUserInterface() {
    if (currentUser) {
        document.getElementById('currentUserName').textContent = currentUser.name;
        document.getElementById('currentUserInfo').style.display = "block";
        document.getElementById('logoutBtn').style.display = "block";
        document.getElementById('syncBtn').style.display = "block";
        document.getElementById('syncStatus').style.display = "block";
        
        if (currentUser.role === "admin") {
            document.getElementById('currentUserRole').style.display = "inline-block";
            document.getElementById('adminToggleBtn').style.display = "block";
        }
    }
}

// ==================== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ====================
async function loadCompetitions() {
    try {
        updateSyncStatus("ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...", "syncing");
        
        const cloudData = await loadFromCloud();
        if (cloudData?.competitions) {
            window.competitions = cloudData.competitions;
            
            updateAppStats();
            displayCompetitionsHistory();
            updatePlayersLists();
            
            showToast(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${window.competitions.length} Ø¯ÙˆØ±ÙŠ`);
            
        } else if (cloudData === null) {
            // Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„
            window.competitions = [];
            updateAppStats();
            displayCompetitionsHistory();
            updatePlayersLists();
            
            document.getElementById('competitionsHistory').innerHTML = 
                '<p style="text-align: center; color: #ef4444;">âŒ ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</p>';
        }
        
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
        window.competitions = [];
        updateAppStats();
        displayCompetitionsHistory();
        updatePlayersLists();
        updateSyncStatus("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„", "error");
        showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
    }
}

// ==================== Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ÙÙ‚Ø· ====================
window.saveCompetition = async function() {
    // Ù…Ù†Ø¹ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
    if (window.isSaving) {
        showToast("â³ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...", "warning");
        return;
    }
    
    let players = [];
    
    if (document.getElementById('type').value === "individual") {
        document.querySelectorAll("#individuals input").forEach(i => {
            const name = i.value.trim();
            if (name) players.push(name);
        });
    } else {
        document.querySelectorAll("#teams div").forEach(r => {
            const a = r.children[0].value.trim();
            const b = r.children[1].value.trim();
            if (a && b) players.push(`${a} & ${b}`);
        });
    }
    
    if (players.length < 2) {
        showToast("âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„", "warning");
        return;
    }
    
    if (!currentUser) {
        showToast("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹", "error");
        return;
    }
    
    if (!window.isOnline) {
        showToast("âŒ ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª", "error");
        return;
    }
    
    const now = new Date();
    const competitionData = {
        players: players,
        addedBy: currentUser.username,
        addedByName: currentUser.name,
        timestamp: now.toISOString(),
        date: now.toLocaleDateString('ar-SA'),
        time: now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }),
        dateTime: now.toLocaleString('ar-SA')
    };
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®)
    const isDuplicate = window.competitions.some(comp => {
        const compDate = comp.date || '';
        const compTime = comp.time || '';
        const currentDate = competitionData.date;
        const currentTime = competitionData.time;
        
        // Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
        return JSON.stringify(comp.players) === JSON.stringify(competitionData.players) &&
               compDate === currentDate &&
               Math.abs(new Date(compTime) - new Date(currentTime)) < 60000; // Ø®Ù„Ø§Ù„ Ø¯Ù‚ÙŠÙ‚Ø©
    });
    
    if (isDuplicate) {
        showToast("âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ±ÙŠ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„!", "warning");
        return;
    }
    
    try {
        // ØªÙØ¹ÙŠÙ„ Ù‚ÙÙ„ Ù…Ù†Ø¹ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
        window.isSaving = true;
        updateSaveButtonState(true);
        updateSyncStatus("ğŸ’¾ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±ÙŠ...", "syncing");
        
        // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
        const firebaseId = await saveToCloud(competitionData);
        
        if (firebaseId) {
            showToast(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±ÙŠ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©\nğŸ‘¤ ${currentUser.name}`, "info", 2000);
            clearForm();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
            updateAppStats();
            displayCompetitionsHistory();
            updatePlayersLists();
            
            updateSyncStatus("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­", "online");
        }
        
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±ÙŠ:", error);
        showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±ÙŠ: " + error.message, "error");
        updateSyncStatus("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸", "error");
    } finally {
        // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚ÙÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
        window.isSaving = false;
        updateSaveButtonState(false);
    }
};

// ==================== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ====================
function updateAppStats() {
    document.getElementById('totalCompetitions').textContent = window.competitions.length;
    
    // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„ÙØ±ÙŠØ¯ÙŠÙ†
    const uniquePlayers = new Set();
    window.competitions.forEach(c => {
        c.players.forEach(p => {
            if (p.includes(" & ")) {
                p.split(" & ").forEach(pl => uniquePlayers.add(pl.trim()));
            } else {
                uniquePlayers.add(p.trim());
            }
        });
    });
    
    document.getElementById('totalPlayers').textContent = uniquePlayers.size;
    window.allPlayers = uniquePlayers;
}

// ==================== Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® ====================
function displayCompetitionsHistory() {
    let html = '';
    const recent = window.competitions.slice(0, 15);
    
    if (recent.length === 0) {
        html = '<p style="text-align: center; color: #94a3b8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙˆØ±ÙŠØ§Øª</p>';
    } else {
        recent.forEach(c => {
            // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø­Ø°Ù ÙÙ‚Ø· Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø¯Ù…Ù† ÙˆØ¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø°Ù
            const deleteBtn = (currentUser?.role === "admin") ? 
                `<button class="delete-btn" onclick="deleteCompetition('${c.firebaseId}')" title="Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±ÙŠ">Ã—</button>` : '';
            
            html += `
                <div class="competition-item ${(currentUser?.role === "admin" && deleteMode) ? "admin-visible" : ""}">
                    ${deleteBtn}
                    <div style="margin-bottom: 8px;">
                        <strong>ğŸ‘¥ ${c.players.join('ØŒ ')}</strong>
                    </div>
                    <div style="font-size: 0.9em;">
                        <span class="user-badge">ğŸ‘¤ ${c.addedByName}</span>
                        <span class="time-badge">ğŸ“… ${c.date}</span>
                        <span class="time-badge">â° ${c.time}</span>
                    </div>
                </div>
            `;
        });
    }
    
    document.getElementById('competitionsHistory').innerHTML = html;
}

// ==================== Ø¨Ù‚ÙŠØ© Ø§Ù„ÙˆØ¸Ø§Ø¦Ù ====================
window.toggleAdminPanel = function() {
    const panel = document.getElementById('adminPanel');
    panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
};

window.exportCSV = async function() {
    if (currentUser?.role !== "admin") return;
    
    try {
        updateSyncStatus("ğŸ“Š Ø¬Ø§Ø±ÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...", "syncing");
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
        await loadCompetitions();
        
        let csv = "ØªØ§Ø±ÙŠØ®,ÙˆÙ‚Øª,Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†,Ø£Ø¶ÙŠÙ Ø¨ÙˆØ§Ø³Ø·Ø©,Ù…Ø¹Ø±Ù Ø§Ù„Ø³Ø­Ø§Ø¨Ø©\n";
        window.competitions.forEach(c => {
            csv += `"${c.date}","${c.time}","${c.players.join(', ')}","${c.addedByName}","${c.firebaseId}"\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `kingbad_data_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        updateSyncStatus("âœ… ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±", "online");
        showToast(`âœ… ØªÙ… ØªØµØ¯ÙŠØ± ${window.competitions.length} Ø¯ÙˆØ±ÙŠ`);
        
    } catch (error) {
        updateSyncStatus("âŒ ÙØ´Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±", "error");
        showToast("âŒ ÙØ´Ù„ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
    }
};

// ==================== Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø³Ù†Ø© Ù…Ø¹ Ù†Ø³Ø¨ Ø§Ù„ÙƒÙ†Ø¬ ÙˆØ§Ù„Ø¨Ø¹Ø±ÙˆØ± ====================
window.buildStats = function(filter) {
    let stats = {};
    
    window.competitions.forEach(c => {
        const type = c.players.every(p => !p.includes(" & ")) ? "individual" : "team";
        if (filter !== "all" && filter !== type) return;
        
        const first = c.players[0];
        const last = c.players[c.players.length - 1];
        
        const firstPlayers = first.includes(" & ") ? first.split(" & ") : [first];
        const lastPlayers = last.includes(" & ") ? last.split(" & ") : [last];
        
        c.players.forEach(player => {
            const players = player.includes(" & ") ? player.split(" & ") : [player];
            players.forEach(p => {
                p = p.trim();
                if (!stats[p]) stats[p] = {total:0,king:0,bad:0};
                stats[p].total++;
            });
        });
        
        firstPlayers.forEach(p => { 
            p = p.trim();
            if(stats[p]) stats[p].king++; 
        });
        
        lastPlayers.forEach(p => { 
            p = p.trim();
            if(stats[p]) stats[p].bad++; 
        });
    });
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨
    Object.keys(stats).forEach(player => {
        const data = stats[player];
        data.winRate = data.total > 0 ? ((data.king / data.total) * 100).toFixed(1) : 0;
        data.kingRate = data.total > 0 ? ((data.king / data.total) * 100).toFixed(1) : 0;
        data.badRate = data.total > 0 ? ((data.bad / data.total) * 100).toFixed(1) : 0;
    });
    
    return stats;
};

window.toggleStats = function(type) {
    const stats = window.buildStats(type);
    const statsBox = document.getElementById('statsBox');
    
    let title = type === 'individual' ? "ğŸ® Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙØ±Ø¯ÙŠØ©" : 
                type === 'team' ? "ğŸ‘¥ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙØ±Ù‚" : "ğŸ“ˆ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©";
    
    let html = `<h4>${title}</h4>`;
    
    if (Object.keys(stats).length === 0) {
        html += '<p style="color: #94a3b8; text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
    } else {
        const sorted = Object.entries(stats).sort((a,b) => b[1].total - a[1].total);
        
        sorted.forEach(([player, data]) => {
            html += `
                <div class="competition-item">
                    <div style="margin-bottom: 10px;">
                        <strong>${player}</strong>
                        <div style="font-size: 0.85em; color: #94a3b8; margin-top: 5px;">
                            <span class="user-badge">ğŸ® ${data.total} Ù…Ø¨Ø§Ø±Ø§Ø©</span>
                        </div>
                    </div>
                    
                    <div class="stats-row">
                        <span>ğŸ‘‘ Ø§Ù„ÙƒÙ†Ø¬:</span>
                        <div>
                            <span>${data.king}</span>
                            <span class="rate-badge" style="margin-right: 8px;">${data.kingRate}%</span>
                        </div>
                    </div>
                    
                    <div class="stats-row">
                        <span>ğŸ¤¡ Ø§Ù„Ø¨Ø¹Ø±ÙˆØ±:</span>
                        <div>
                            <span>${data.bad}</span>
                            <span class="rate-badge" style="margin-right: 8px; background: #ef4444;">${data.badRate}%</span>
                        </div>
                    </div>
                    
                    <div class="stats-row">
                        <span>ğŸ“Š Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ²:</span>
                        <span style="color: #22c55e; font-weight: bold;">${data.winRate}%</span>
                    </div>
                    
                    <div class="progress-bar" style="margin-top: 10px;">
                        <div class="progress" style="width: ${data.kingRate}%; background: #22c55e;"></div>
                    </div>
                </div>
            `;
        });
    }
    
    statsBox.innerHTML = html;
};

window.showTopPlayers = function() {
    const stats = window.buildStats('all');
    const sorted = Object.entries(stats).sort((a,b) => {
        // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ² Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ†Ø¬
        const aWinRate = parseFloat(a[1].winRate);
        const bWinRate = parseFloat(b[1].winRate);
        if (bWinRate !== aWinRate) return bWinRate - aWinRate;
        return b[1].king - a[1].king;
    }).slice(0, 10);
    
    let html = '<h4>ğŸ† Ø£ÙØ¶Ù„ 10 Ù„Ø§Ø¹Ø¨ÙŠÙ† (Ø¨Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ²)</h4>';
    
    if (sorted.length === 0) {
        html += '<p style="color: #94a3b8; text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
    } else {
        sorted.forEach(([player, data], index) => {
            const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : 'ğŸ–ï¸';
            
            html += `
                <div class="competition-item">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <strong>${medal} ${player}</strong>
                            <div style="font-size: 0.85em; color: #94a3b8; margin-top: 5px;">
                                <span class="user-badge">ğŸ® ${data.total}</span>
                            </div>
                        </div>
                        <div style="text-align: left; font-size: 1.2em; font-weight: bold; color: #22c55e;">
                            ${data.winRate}%
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center;">
                        <div>
                            <div style="font-size: 1em; font-weight: bold; color: #fbbf24;">${data.king}</div>
                            <div style="font-size: 0.8em; color: #94a3b8;">ğŸ‘‘ Ø§Ù„ÙƒÙ†Ø¬</div>
                        </div>
                        <div>
                            <div style="font-size: 1em; font-weight: bold; color: #ef4444;">${data.bad}</div>
                            <div style="font-size: 0.8em; color: #94a3b8;">ğŸ¤¡ Ø§Ù„Ø¨Ø¹Ø±ÙˆØ±</div>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    document.getElementById('statsBox').innerHTML = html;
};

window.toggleCompare = function() {
    const playerA = document.getElementById('playerA').value;
    const playerB = document.getElementById('playerB').value;
    const element = document.getElementById('compareElement').value;
    
    if (!playerA || !playerB) {
        showToast("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©", "warning");
        return;
    }
    
    if (playerA === playerB) {
        showToast("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù…Ø®ØªÙ„ÙÙŠÙ†", "warning");
        return;
    }
    
    const stats = window.buildStats("all");
    const aStats = stats[playerA] || { total: 0, king: 0, bad: 0, winRate: 0, kingRate: 0, badRate: 0 };
    const bStats = stats[playerB] || { total: 0, king: 0, bad: 0, winRate: 0, kingRate: 0, badRate: 0 };
    
    let aValue, bValue, aLabel, bLabel;
    switch(element) {
        case 'total': 
            aValue = aStats.total; 
            bValue = bStats.total;
            aLabel = 'ğŸ® Ù…Ø¨Ø§Ø±Ø§Ø©';
            bLabel = 'ğŸ® Ù…Ø¨Ø§Ø±Ø§Ø©';
            break;
        case 'king': 
            aValue = aStats.king; 
            bValue = bStats.king;
            aLabel = 'ğŸ‘‘ ÙƒÙ†Ø¬';
            bLabel = 'ğŸ‘‘ ÙƒÙ†Ø¬';
            break;
        case 'bad': 
            aValue = aStats.bad; 
            bValue = bStats.bad;
            aLabel = 'ğŸ¤¡ Ø¨Ø¹Ø±ÙˆØ±';
            bLabel = 'ğŸ¤¡ Ø¨Ø¹Ø±ÙˆØ±';
            break;
        case 'winRate': 
            aValue = parseFloat(aStats.winRate); 
            bValue = parseFloat(bStats.winRate);
            aLabel = 'ğŸ“Š %';
            bLabel = 'ğŸ“Š %';
            break;
        case 'kingRate': 
            aValue = parseFloat(aStats.kingRate); 
            bValue = parseFloat(bStats.kingRate);
            aLabel = 'ğŸ‘‘ %';
            bLabel = 'ğŸ‘‘ %';
            break;
        case 'badRate': 
            aValue = parseFloat(aStats.badRate); 
            bValue = parseFloat(bStats.badRate);
            aLabel = 'ğŸ¤¡ %';
            bLabel = 'ğŸ¤¡ %';
            break;
    }
    
    let winner = "";
    if (aValue > bValue) {
        const diff = (aValue - bValue).toFixed(1);
        winner = `${playerA} ÙŠØªÙÙˆÙ‚ Ø¨Ù€ ${diff}${element.includes('Rate') ? '%' : ''}`;
    } else if (bValue > aValue) {
        const diff = (bValue - aValue).toFixed(1);
        winner = `${playerB} ÙŠØªÙÙˆÙ‚ Ø¨Ù€ ${diff}${element.includes('Rate') ? '%' : ''}`;
    } else {
        winner = "ØªØ¹Ø§Ø¯Ù„ ØªØ§Ù…";
    }
    
    const compareResult = document.getElementById('compareResult');
    compareResult.innerHTML = `
        <div style="text-align: center;">
            <h4>ğŸ†š Ù…Ù‚Ø§Ø±Ù†Ø© ${element.includes('Rate') ? 'Ø§Ù„Ù†Ø³Ø¨' : ''}</h4>
            <div style="display: flex; justify-content: space-around; margin: 20px 0;">
                <div style="text-align: center;">
                    <div style="font-size: 2em; font-weight: bold; color: #22c55e;">${aValue}${element.includes('Rate') ? '%' : ''}</div>
                    <div style="font-size: 1.1em;">${playerA}</div>
                    <div style="font-size: 0.85em; color: #94a3b8; margin-top: 5px;">
                        ${aLabel}
                    </div>
                </div>
                <div style="align-self: center; font-size: 1.5em;">VS</div>
                <div style="text-align: center;">
                    <div style="font-size: 2em; font-weight: bold; color: #3b82f6;">${bValue}${element.includes('Rate') ? '%' : ''}</div>
                    <div style="font-size: 1.1em;">${playerB}</div>
                    <div style="font-size: 0.85em; color: #94a3b8; margin-top: 5px;">
                        ${bLabel}
                    </div>
                </div>
            </div>
            
            <div style="background: #1e293b; padding: 15px; border-radius: 8px; margin-top: 15px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div style="text-align: center;">
                        <div style="color: #fbbf24;">ğŸ‘‘ ${aStats.king} (${aStats.kingRate}%)</div>
                        <div style="font-size: 0.8em; color: #94a3b8;">${playerA}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #fbbf24;">ğŸ‘‘ ${bStats.king} (${bStats.kingRate}%)</div>
                        <div style="font-size: 0.8em; color: #94a3b8;">${playerB}</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div style="text-align: center;">
                        <div style="color: #ef4444;">ğŸ¤¡ ${aStats.bad} (${aStats.badRate}%)</div>
                        <div style="font-size: 0.8em; color: #94a3b8;">${playerA}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #ef4444;">ğŸ¤¡ ${bStats.bad} (${bStats.badRate}%)</div>
                        <div style="font-size: 0.8em; color: #94a3b8;">${playerB}</div>
                    </div>
                </div>
            </div>
            
            <div style="background: #1e293b; padding: 10px; border-radius: 8px; margin-top: 15px;">
                <strong style="color: #fbbf24;">ğŸ† Ø§Ù„Ù†ØªÙŠØ¬Ø©:</strong> ${winner}
            </div>
        </div>
    `;
};

window.showMyStats = function() {
    const myCompetitions = window.competitions.filter(c => c.addedBy === currentUser.username);
    const myStats = window.buildStats('all');
    const myPlayerStats = myStats[currentUser.name] || { total: 0, king: 0, bad: 0, winRate: 0, kingRate: 0, badRate: 0 };
    
    let html = `<h4>ğŸ‘¤ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ${currentUser.name}</h4>`;
    
    html += `
        <div class="competition-item">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
                <div>
                    <div style="font-size: 1.5em; font-weight: bold; color: #22c55e;">${myCompetitions.length}</div>
                    <div style="font-size: 0.9em; color: #94a3b8;">Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ©</div>
                </div>
                <div>
                    <div style="font-size: 1.5em; font-weight: bold; color: #3b82f6;">${myPlayerStats.total}</div>
                    <div style="font-size: 0.9em; color: #94a3b8;">Ù…Ø´Ø§Ø±ÙƒØ§Øª</div>
                </div>
            </div>
        </div>
        
        <div class="competition-item">
            <div class="stats-row">
                <span>ğŸ‘‘ Ø§Ù„ÙƒÙ†Ø¬:</span>
                <div>
                    <span>${myPlayerStats.king}</span>
                    <span class="rate-badge" style="margin-right: 8px;">${myPlayerStats.kingRate}%</span>
                </div>
            </div>
            
            <div class="stats-row">
                <span>ğŸ¤¡ Ø§Ù„Ø¨Ø¹Ø±ÙˆØ±:</span>
                <div>
                    <span>${myPlayerStats.bad}</span>
                    <span class="rate-badge" style="margin-right: 8px; background: #ef4444;">${myPlayerStats.badRate}%</span>
                </div>
            </div>
            
            <div class="stats-row">
                <span>ğŸ“Š Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ²:</span>
                <span style="color: #22c55e; font-weight: bold;">${myPlayerStats.winRate}%</span>
            </div>
        </div>
    `;
    
    if (myCompetitions.length > 0) {
        html += '<h5 style="margin-top: 20px;">ğŸ“ Ø¢Ø®Ø± Ø¯ÙˆØ±ÙŠØ§ØªÙŠ:</h5>';
        myCompetitions.slice(0, 5).forEach(comp => {
            html += `
                <div class="competition-item">
                    <div style="margin-bottom: 8px;">
                        <strong>ğŸ‘¥ ${comp.players.join('ØŒ ')}</strong>
                    </div>
                    <div style="font-size: 0.85em; color: #94a3b8;">
                        <span class="time-badge">ğŸ“… ${comp.date}</span>
                        <span class="time-badge">â° ${comp.time}</span>
                    </div>
                </div>
            `;
        });
    }
    
    document.getElementById('statsBox').innerHTML = html;
};

window.showHistory = function() {
    let html = '<h4>ğŸ“œ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª</h4>';
    
    if (window.competitions.length === 0) {
        html += '<p style="color: #94a3b8; text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙˆØ±ÙŠØ§Øª</p>';
    } else {
        window.competitions.forEach(comp => {
            const deleteBtn = (currentUser?.role === "admin") ? 
                `<button class="delete-btn" onclick="deleteCompetition('${comp.firebaseId}')" title="Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±ÙŠ">Ã—</button>` : '';
            
            html += `
                <div class="competition-item ${(currentUser?.role === "admin" && deleteMode) ? "admin-visible" : ""}">
                    ${deleteBtn}
                    <div style="margin-bottom: 8px;">
                        <strong>ğŸ‘¥ ${comp.players.join('ØŒ ')}</strong>
                    </div>
                    <div style="font-size: 0.85em;">
                        <span class="user-badge">ğŸ‘¤ ${comp.addedByName}</span>
                        <span class="time-badge">ğŸ“… ${comp.date}</span>
                        <span class="time-badge">â° ${comp.time}</span>
                    </div>
                </div>
            `;
        });
    }
    
    document.getElementById('statsBox').innerHTML = html;
};

// ==================== ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© ====================
function updatePlayersLists() {
    const datalist = document.getElementById('playersDatalist');
    const playerA = document.getElementById('playerA');
    const playerB = document.getElementById('playerB');
    
    window.allPlayers.clear();
    window.competitions.forEach(c => {
        c.players.forEach(p => {
            if (p.includes(" & ")) {
                p.split(" & ").forEach(pl => window.allPlayers.add(pl.trim()));
            } else {
                window.allPlayers.add(p.trim());
            }
        });
    });
    
    datalist.innerHTML = '';
    playerA.innerHTML = '<option value="">ğŸ‘¤ Ø§Ø®ØªØ± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„</option>';
    playerB.innerHTML = '<option value="">ğŸ‘¤ Ø§Ø®ØªØ± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>';
    
    [...window.allPlayers].forEach(player => {
        datalist.innerHTML += `<option value="${player}">`;
        playerA.innerHTML += `<option value="${player}">${player}</option>`;
        playerB.innerHTML += `<option value="${player}">${player}</option>`;
    });
}

function switchMode() {
    const type = document.getElementById('type').value;
    document.getElementById('individualBox').style.display = type === "individual" ? "block" : "none";
    document.getElementById('teamBox').style.display = type === "team" ? "block" : "none";
}

function addIndividual() {
    const div = document.createElement('div');
    div.innerHTML = `<input list="playersDatalist" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨">`;
    document.getElementById('individuals').appendChild(div);
}

function addTeam() {
    const div = document.createElement('div');
    div.innerHTML = `
        <input list="playersDatalist" placeholder="Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„">
        <input list="playersDatalist" placeholder="Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ">
    `;
    document.getElementById('teams').appendChild(div);
}

function clearForm() {
    document.querySelectorAll("#individuals input").forEach(i => i.value = "");
    document.querySelectorAll("#teams input").forEach(i => i.value = "");
    document.getElementById('individuals').innerHTML = '';
    document.getElementById('teams').innerHTML = '';
    addIndividual();
    addIndividual();
}

function quickAddPlayers() {
    const commonPlayers = ['Ø§Ù„Ø¹Ø¨Ø¯Ù„ÙŠ', 'Ù…Ø­Ù…Ø¯', 'Ø£Ø­Ù…Ø¯', 'Ø®Ø§Ù„Ø¯', 'Ø¹Ù…Ø±', 'Ø¹Ù„ÙŠ'];
    const container = document.getElementById('individuals');
    container.innerHTML = '';
    
    commonPlayers.forEach(player => {
        const div = document.createElement('div');
        div.innerHTML = `<input list="playersDatalist" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨" value="${player}">`;
        container.appendChild(div);
    });
}

function showConfirmModal(title, message, callback) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalMessage').textContent = message;
    document.getElementById('confirmModal').style.display = 'flex';
    window.pendingAction = callback;
}

window.confirmAction = function(confirmed) {
    document.getElementById('confirmModal').style.display = 'none';
    if (confirmed && window.pendingAction) window.pendingAction();
    window.pendingAction = null;
};

// ==================== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯Ù…Ù† ====================
window.showUsersManagement = function() {
    if (currentUser?.role !== "admin") return;
    
    let html = '<h4>ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h4>';
    
    USERS.forEach(user => {
        const userCompetitions = window.competitions.filter(c => c.addedBy === user.u).length;
        html += `
            <div class="competition-item">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${user.n}</strong>
                        <div style="font-size: 0.85em; color: #94a3b8;">
                            ${user.u} | ${user.r === 'admin' ? 'Ø£Ø¯Ù…Ù†' : 'Ù…Ø³ØªØ®Ø¯Ù…'} | Ø¯ÙˆØ±ÙŠØ§Øª: ${userCompetitions}
                        </div>
                    </div>
                    ${user.u !== currentUser.username ? 
                        `<button onclick="deleteUser('${user.u}')" class="danger" style="padding: 5px 10px; font-size: 0.8em;">Ø­Ø°Ù</button>` : 
                        `<span style="color: #94a3b8; font-size: 0.8em;">(Ø£Ù†Øª)</span>`
                    }
                </div>
            </div>
        `;
    });
    
    html += `
        <div style="margin-top: 20px;">
            <input type="text" id="newUserUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯" style="margin-bottom: 10px;">
            <input type="password" id="newUserPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="margin-bottom: 10px;">
            <input type="text" id="newUserName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶" style="margin-bottom: 10px;">
            <select id="newUserRole" style="margin-bottom: 10px;">
                <option value="user">Ù…Ø³ØªØ®Ø¯Ù…</option>
                <option value="admin">Ø£Ø¯Ù…Ù†</option>
            </select>
            <button onclick="addNewUser()" class="secondary">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
        </div>
    `;
    
    document.getElementById('statsBox').innerHTML = html;
};

function deleteUser(username) {
    if (username === currentUser.username) {
        showToast("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø®Ø§Øµ", "error");
        return;
    }
    
    showConfirmModal("Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…", `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${username}"ØŸ`, () => {
        USERS = USERS.filter(u => u.u !== username);
        showToast("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
        showUsersManagement();
    });
}

function addNewUser() {
    const username = document.getElementById('newUserUsername').value.trim();
    const password = document.getElementById('newUserPassword').value;
    const name = document.getElementById('newUserName').value.trim();
    const role = document.getElementById('newUserRole').value;
    
    if (!username || !password || !name) {
        showToast("âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„", "warning");
        return;
    }
    
    if (USERS.find(u => u.u === username)) {
        showToast("âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„", "error");
        return;
    }
    
    USERS.push({ u: username, p: password, n: name, r: role });
    
    document.getElementById('newUserUsername').value = '';
    document.getElementById('newUserPassword').value = '';
    document.getElementById('newUserName').value = '';
    
    showToast(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${name}"`);
    showUsersManagement();
}

window.showPlayersManagement = function() {
    let html = '<h4>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h4>';
    
    const playerStats = window.buildStats('all');
    const sortedPlayers = Object.entries(playerStats).sort((a, b) => b[1].total - a[1].total);
    
    if (sortedPlayers.length === 0) {
        html += '<p style="color: #94a3b8; text-align: center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ†</p>';
    } else {
        sortedPlayers.forEach(([player, data]) => {
            html += `
                <div class="competition-item">
                    <div style="margin-bottom: 10px;">
                        <strong>${player}</strong>
                        <div style="font-size: 0.85em; color: #94a3b8; margin-top: 5px;">
                            <span class="user-badge">ğŸ® ${data.total} Ù…Ø¨Ø§Ø±Ø§Ø©</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <span>ğŸ‘‘ Ø§Ù„ÙƒÙ†Ø¬:</span>
                        <span>${data.king} (${data.kingRate}%)</span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <span>ğŸ¤¡ Ø§Ù„Ø¨Ø¹Ø±ÙˆØ±:</span>
                        <span>${data.bad} (${data.badRate}%)</span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>ğŸ“Š Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ²:</span>
                        <span style="color: #22c55e; font-weight: bold;">${data.winRate}%</span>
                    </div>
                </div>
            `;
        });
    }
    
    document.getElementById('statsBox').innerHTML = html;
};

window.resetAllData = async function() {
    if (currentUser?.role !== "admin") {
        showToast("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØµÙÙŠØ±", "error");
        return;
    }
    
    showConfirmModal("ğŸ”¥ ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", 
        "âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!", 
        async () => {
            try {
                if (!window.isOnline) {
                    showToast("âŒ ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª", "error");
                    return;
                }
                
                updateSyncStatus("ğŸ”¥ Ø¬Ø§Ø±ÙŠ ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...", "syncing");
                
                // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª Ù„Ø­Ø°ÙÙ‡Ø§
                const response = await fetch(
                    "https://firestore.googleapis.com/v1/projects/winner-71276/databases/(default)/documents/competitions",
                    { headers: { 'Accept': 'application/json' } }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    let deletedCount = 0;
                    
                    if (data.documents && data.documents.length > 0) {
                        for (const doc of data.documents) {
                            try {
                                await fetch(`https://firestore.googleapis.com/v1/${doc.name}`, { 
                                    method: 'DELETE',
                                    signal: AbortSignal.timeout(5000)
                                });
                                deletedCount++;
                            } catch (e) {
                                console.error(`âŒ ÙØ´Ù„ Ø­Ø°Ù Ù…Ø³ØªÙ†Ø¯: ${doc.name}`, e);
                            }
                        }
                    }
                    
                    // ØªØµÙÙŠØ± Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                    window.competitions = [];
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                    updateAppStats();
                    displayCompetitionsHistory();
                    updatePlayersLists();
                    
                    updateSyncStatus("âœ… ØªÙ… Ø§Ù„ØªØµÙÙŠØ±", "online");
                    showToast(`âœ… ØªÙ… Ø­Ø°Ù ${deletedCount} Ø¯ÙˆØ±ÙŠ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©`);
                    
                } else {
                    throw new Error('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­Ø°Ù');
                }
                
            } catch (error) {
                console.error("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµÙÙŠØ±:", error);
                updateSyncStatus("âŒ ÙØ´Ù„ Ø§Ù„ØªØµÙÙŠØ±", "error");
                showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
            }
        }
    );
};

window.showSyncStats = function() {
    let html = '<h4>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h4>';
    
    const stats = window.buildStats('all');
    const totalPlayers = Object.keys(stats).length;
    const totalCompetitions = window.competitions.length;
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø·Ø§Øª
    let avgWinRate = 0;
    let avgKingRate = 0;
    let avgBadRate = 0;
    
    if (totalPlayers > 0) {
        Object.values(stats).forEach(data => {
            avgWinRate += parseFloat(data.winRate);
            avgKingRate += parseFloat(data.kingRate);
            avgBadRate += parseFloat(data.badRate);
        });
        
        avgWinRate = (avgWinRate / totalPlayers).toFixed(1);
        avgKingRate = (avgKingRate / totalPlayers).toFixed(1);
        avgBadRate = (avgBadRate / totalPlayers).toFixed(1);
    }
    
    html += `
        <div class="competition-item">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center;">
                <div>
                    <div style="font-size: 1.5em; font-weight: bold; color: #22c55e;">${totalCompetitions}</div>
                    <div style="font-size: 0.9em; color: #94a3b8;">Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª</div>
                </div>
                <div>
                    <div style="font-size: 1.5em; font-weight: bold; color: #3b82f6;">${totalPlayers}</div>
                    <div style="font-size: 0.9em; color: #94a3b8;">Ù„Ø§Ø¹Ø¨ÙŠÙ†</div>
                </div>
            </div>
        </div>
        
        <div class="competition-item">
            <h5 style="margin-top: 0; margin-bottom: 15px; text-align: center;">ğŸ“ˆ Ø§Ù„Ù…ØªÙˆØ³Ø·Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h5>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center;">
                <div>
                    <div style="font-size: 1.2em; font-weight: bold; color: #fbbf24;">${avgKingRate}%</div>
                    <div style="font-size: 0.8em; color: #94a3b8;">ğŸ‘‘ Ø§Ù„ÙƒÙ†Ø¬</div>
                </div>
                <div>
                    <div style="font-size: 1.2em; font-weight: bold; color: #ef4444;">${avgBadRate}%</div>
                    <div style="font-size: 0.8em; color: #94a3b8;">ğŸ¤¡ Ø§Ù„Ø¨Ø¹Ø±ÙˆØ±</div>
                </div>
                <div>
                    <div style="font-size: 1.2em; font-weight: bold; color: #22c55e;">${avgWinRate}%</div>
                    <div style="font-size: 0.8em; color: #94a3b8;">ğŸ“Š Ø§Ù„ÙÙˆØ²</div>
                </div>
            </div>
        </div>
        
        <div class="competition-item">
            <div style="text-align: center;">
                <div style="font-size: 1em; margin-bottom: 10px;">
                    Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…: <span class="${window.firebaseEnabled ? 'online' : 'offline'}">
                    ${window.firebaseEnabled ? 'ğŸŸ¢ Ù†Ø´Ø·' : 'ğŸ”´ Ù…Ø¹Ø·Ù„'}
                    </span>
                </div>
                <div style="font-size: 0.9em; color: #94a3b8;">
                    Ø§Ù„Ø§ØªØµØ§Ù„: <span class="${window.isOnline ? 'online' : 'offline'}">
                    ${window.isOnline ? 'ğŸŸ¢ Ù…ØªØµÙ„' : 'ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„'}
                    </span>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('statsBox').innerHTML = html;
};

// ==================== Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ====================
window.onload = function() {
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙÙ‚Ø·
    if (window.sessionUser) {
        currentUser = window.sessionUser;
        updateUserInterface();
        document.getElementById('loginBox').style.display = "none";
        document.getElementById('appBox').style.display = "block";
        loadCompetitions();
    }
    
    addIndividual();
    addIndividual();
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    window.addEventListener('online', () => {
        window.isOnline = true;
        updateSyncStatus("ğŸŸ¢ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª", "online");
        if (currentUser) {
            loadCompetitions();
        }
    });
    
    window.addEventListener('offline', () => {
        window.isOnline = false;
        updateSyncStatus("ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„", "offline");
    });
    
    if (navigator.onLine) {
        updateSyncStatus("ğŸŸ¢ Ø¬Ø§Ù‡Ø²", "online");
    } else {
        updateSyncStatus("ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„", "offline");
    }
};
</script>
</body>
</html>
