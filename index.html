<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KingBad Stats ğŸ‘‘ğŸ¤¡</title>
<style>
*,:after,:before{box-sizing:border-box;margin:0;padding:0}body{font-family:Tahoma,sans-serif;background:#020617;color:#fff;padding:20px;direction:rtl;margin:0;overflow-x:hidden}.card{background:#0f172a;padding:15px;border-radius:10px;border:1px solid #1e293b;max-width:600px;margin:20px auto;box-shadow:0 4px 6px rgba(0,0,0,.3)}h1,h2,h3,h4{color:#e2e8f0;margin-top:0}h1{text-align:center;color:#fbbf24;margin-bottom:20px}input,select,button{width:100%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #334155;font-size:14px;box-sizing:border-box}input,select{background:#1e293b;color:#e2e8f0}button{background:#22c55e;color:#fff;font-weight:bold;cursor:pointer;border:none;transition:background .3s}button:hover{background:#16a34a}button.secondary{background:#3b82f6}button.secondary:hover{background:#2563eb}button.danger{background:#ef4444}button.danger:hover{background:#dc2626}button.admin{background:#8b5cf6}button.admin:hover{background:#7c3aed}button.warning{background:#f59e0b}button.warning:hover{background:#d97706}.app{display:none}#loginMsg{text-align:center;margin-top:10px;color:#ef4444;font-size:14px}#individualBox,#teamBox{margin-top:15px}#individuals input,#teams input{margin:5px 0}#teams div{display:flex;gap:10px;margin:5px 0}#teams div input{flex:1}.stats-buttons{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}.stats-buttons button{flex:1;min-width:80px}#statsBox,#compareResult,#competitionsHistory,#strongStatsBox,#strongResultsHistory{margin-top:15px;padding:15px;background:#1e293b;border-radius:8px;min-height:50px}.competition-item{background:#1e293b;margin:10px 0;padding:12px;border-radius:8px;border-right:4px solid #22c55e;transition:all .3s;position:relative}.competition-item:hover{background:#334155;transform:translateX(-5px)}.user-badge{display:inline-block;background:#3b82f6;color:#fff;padding:2px 10px;border-radius:12px;font-size:.85em;margin:0 5px}.time-badge{display:inline-block;background:#10b981;color:#fff;padding:2px 10px;border-radius:12px;font-size:.85em;margin:0 5px}.admin-badge{display:inline-block;background:#8b5cf6;color:#fff;padding:2px 10px;border-radius:12px;font-size:.85em;margin:0 5px}.info-text{color:#94a3b8;font-size:.9em;margin-top:5px}.current-user{position:fixed;top:20px;left:20px;background:#1e293b;padding:8px 15px;border-radius:20px;font-size:.9em;border:1px solid #334155;z-index:1000}.logout-btn{position:fixed;top:20px;right:20px;background:#ef4444;color:#fff;padding:8px 15px;border-radius:20px;border:none;cursor:pointer;font-size:.9em;z-index:1000}.logout-btn:hover{background:#dc2626}.admin-panel{position:fixed;top:60px;right:20px;background:#1e293b;padding:15px;border-radius:10px;border:2px solid #8b5cf6;z-index:1000;width:300px;display:none}.delete-btn{position:absolute;top:5px;left:5px;background:#ef4444;color:#fff;border:none;border-radius:50%;width:25px;height:25px;cursor:pointer;font-size:12px;display:none}.delete-btn:hover{background:#dc2626}.admin-visible .delete-btn{display:block}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:2000;align-items:center;justify-content:center}.modal-content{background:#0f172a;padding:20px;border-radius:10px;max-width:500px;width:90%;border:2px solid #8b5cf6}.modal-buttons{display:flex;gap:10px;margin-top:20px}.player-management{display:grid;grid-template-columns:1fr 1fr;gap:10px}.toggle-btns{position:fixed;top:60px;right:20px;z-index:1000;display:flex;gap:5px}.sync-status{position:fixed;bottom:20px;right:20px;background:#1e293b;padding:8px 15px;border-radius:20px;font-size:.9em;border:1px solid #334155;z-index:1000}.online{color:#22c55e}.offline{color:#ef4444}.syncing{color:#fbbf24}.saving{color:#fbbf24}.loading{color:#3b82f6}.error{color:#ef4444}.toast{position:fixed;bottom:80px;right:20px;background:#0f172a;padding:12px 20px;border-radius:8px;border-left:4px solid #22c55e;box-shadow:0 4px 12px rgba(0,0,0,.4);z-index:2000;max-width:400px;display:none}.toast.error{border-left-color:#ef4444}.toast.warning{border-left-color:#fbbf24}.toast.info{border-left-color:#3b82f6}.progress-bar{height:6px;background:#334155;border-radius:3px;overflow:hidden;margin:10px 0}.progress{height:100%;background:#22c55e;transition:width .3s}.stats-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #334155}.stats-row:last-child{border-bottom:none}.rate-badge{display:inline-block;background:#8b5cf6;color:#fff;padding:2px 8px;border-radius:10px;font-size:.8em}.strong-result-item{background:linear-gradient(135deg,#1a2c4d,#0f172a);border-right:4px solid #f59e0b;border-left:4px solid #ef4444}.score-display{font-size:1.5em;font-weight:bold;text-align:center;margin:10px 0;background:#1e293b;padding:10px;border-radius:8px}.score-display .winner{color:#22c55e}.score-display .loser{color:#ef4444}.score-display .vs{color:#94a3b8;margin:0 10px}.strong-badge{background:linear-gradient(135deg,#f59e0b,#ef4444);color:#020617;font-weight:bold;padding:3px 12px;border-radius:15px;font-size:0.8em;display:inline-block;margin-left:8px}.result-inputs{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center;margin:15px 0}.result-inputs input{text-align:center}.result-inputs span{text-align:center;font-weight:bold;color:#f59e0b}.tab-buttons{display:flex;gap:5px;margin-bottom:15px}.tab-buttons button{flex:1;padding:8px;font-size:0.9em}.tab-buttons .active{background:#f59e0b;color:#020617}.player-card{background:#1e293b;border-radius:10px;padding:15px;margin:10px 0;border-left:4px solid #3b82f6}.player-actions{display:flex;gap:5px;margin-top:10px}.player-actions button{padding:5px 10px;font-size:0.8em}.stat-card{background:linear-gradient(135deg,#1e293b,#0f172a);border-radius:10px;padding:15px;margin:10px 0;border-left:4px solid #22c55e}.compare-result{background:linear-gradient(135deg,#1e293b,#0f172a);border-radius:10px;padding:20px;margin:15px 0;text-align:center;border:2px solid #3b82f6}.compare-result .winner{color:#22c55e;font-size:1.3em;font-weight:bold}.compare-result .loser{color:#ef4444;font-size:1.3em;font-weight:bold}.compare-result .draw{color:#fbbf24;font-size:1.3em;font-weight:bold}.tab-content{display:block}.tab-content[style*="display: none"]{display:none !important}@media (max-width:768px){body{padding:10px}.card{max-width:100%;margin:10px 0;padding:12px}.current-user,.logout-btn,.admin-panel,.toggle-btns,.sync-status{position:static;margin:10px;display:block;width:auto}#teams div{flex-direction:column;gap:5px}.stats-buttons{flex-direction:column}.player-management{grid-template-columns:1fr}.toast{right:10px;left:10px;bottom:100px}.result-inputs{grid-template-columns:1fr;gap:5px}.result-inputs span{order:2}.tab-buttons{flex-direction:column}}
</style>
</head>
<body>

<!-- Toast Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
<div id="toast" class="toast"></div>

<!-- Ù†ÙˆØ§ÙØ° Ø§Ù„ØªØ£ÙƒÙŠØ¯ -->
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</h3>
        <p id="modalMessage">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ</p>
        <div class="modal-buttons">
            <button onclick="confirmAction(true)" class="danger">Ù†Ø¹Ù…</button>
            <button onclick="confirmAction(false)">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
<div id="currentUserInfo" class="current-user" style="display: none;">
    <span id="currentUserName"></span>
    <span id="currentUserRole" class="admin-badge" style="display: none;">Ø£Ø¯Ù…Ù†</span>
</div>

<!-- Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© -->
<div id="syncStatus" class="sync-status" style="display: none;">
    <span id="syncStatusText">ğŸ”µ Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
</div>

<!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
<div class="toggle-btns">
    <button id="adminToggleBtn" class="admin" onclick="toggleAdminPanel()" style="display: none;">âš™ï¸ Ø£Ø¯Ù…Ù†</button>
    <button id="syncBtn" class="secondary" onclick="loadAllData()" style="display: none;">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
</div>

<!-- Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† -->
<div id="adminPanel" class="admin-panel">
    <h3 style="color: #8b5cf6; margin-top: 0;">ğŸ‘‘ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†</h3>
    <div style="display: grid; gap: 10px;">
        <button onclick="toggleDeleteMode()" class="admin">ğŸ—‘ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø°Ù</button>
        <button onclick="exportCSV()" class="admin">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
        <button onclick="showPlayersManagement()" class="admin">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</button>
        <button onclick="showUsersManagement()" class="admin">ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
        <button onclick="showStrongResultsSection()" class="warning">ğŸ’ª Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù‚ÙˆÙŠØ©</button>
        <button onclick="resetAllData()" class="danger">ğŸ”¥ ØªØµÙÙŠØ± Ø§Ù„ÙƒÙ„</button>
        <button onclick="showSyncStats()" class="secondary">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</button>
    </div>
</div>

<button id="logoutBtn" class="logout-btn" onclick="logout()" style="display: none;">ğŸšª Ø®Ø±ÙˆØ¬</button>

<!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div class="card" id="loginBox">
    <h2>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <div style="text-align: center; margin-bottom: 15px;">
        <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #22c55e, #3b82f6); border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 30px;">
            ğŸ‘‘
        </div>
    </div>
    <input id="user" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" autocomplete="off">
    <input id="pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="off">
    <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
    <div id="loginMsg"></div>
    <div class="info-text" style="text-align: center; margin-top: 15px;">
        KingBad Stats v3.5 ğŸ‘‘ğŸ¤¡<br>
        Ù†Ø¸Ø§Ù… Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù… Ù…Ø¹ ØªØ®Ø²ÙŠÙ† Ø³Ø­Ø§Ø¨ÙŠ Ø¨Ø­Øª
    </div>
</div>

<!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<div class="app" id="appBox">
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1 style="margin: 0;">ğŸ‘‘ğŸ¤¡ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙƒÙ†Ø¬ ÙˆØ§Ù„Ø¨Ø¹Ø±ÙˆØ±</h1>
        <div id="appStats" style="font-size: 0.9em; color: #94a3b8;">
            <span id="totalCompetitions">0</span> Ø¯ÙˆØ±ÙŠ | <span id="totalPlayers">0</span> Ù„Ø§Ø¹Ø¨
        </div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ù„Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ -->
    <datalist id="playersDatalist"></datalist>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨ -->
    <div class="tab-buttons">
        <button id="tabCompetitions" class="active" onclick="showTab('competitions')">ğŸ® Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª</button>
        <button id="tabStrongResults" onclick="showTab('strongResults')">ğŸ’ª Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù‚ÙˆÙŠØ©</button>
        <button id="tabStats" onclick="showTab('stats')">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
        <button id="tabCompare" onclick="showTab('compare')">ğŸ†š Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©</button>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª (Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„) -->
    <div id="competitionsTab" class="tab-content">
        <!-- Ù‚Ø³Ù… Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±ÙŠ -->
        <div class="card">
            <h3>â• Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±ÙŠ Ø¬Ø¯ÙŠØ¯</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <select id="type" onchange="switchMode()" style="flex: 1;">
                    <option value="individual">ğŸ® ÙØ±Ø¯ÙŠ</option>
                    <option value="team">ğŸ‘¥ Ø«Ù†Ø§Ø¦ÙŠ</option>
                </select>
                <button onclick="quickAddPlayers()" class="secondary" style="width: auto;">âš¡ Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø©</button>
            </div>

            <div id="individualBox">
                <div id="individuals"></div>
                <button onclick="addIndividual()">â• Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨</button>
            </div>

            <div id="teamBox" style="display:none">
                <div id="teams"></div>
                <button onclick="addTeam()">â• Ø¥Ø¶Ø§ÙØ© ÙØ±ÙŠÙ‚</button>
            </div>

            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button id="saveButton" onclick="saveCompetition()" style="flex: 3;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±ÙŠ</button>
                <button onclick="clearForm()" class="secondary" style="flex: 1;">ğŸ—‘ï¸ Ù…Ø³Ø­</button>
            </div>
            <div class="info-text">
                ğŸ“… Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
            </div>
        </div>

        <!-- Ù‚Ø³Ù… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª -->
        <div class="card">
            <h3>ğŸ“‹ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ©</h3>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div class="info-text">Ø¢Ø®Ø± 15 Ø¯ÙˆØ±ÙŠØ© Ù…Ø¶Ø§ÙØ©</div>
                <button onclick="loadCompetitions()" class="secondary" style="width: auto;">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
            </div>
            <div id="competitionsHistory">
                <p style="text-align: center; color: #94a3b8;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª...</p>
            </div>
        </div>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù‚ÙˆÙŠØ© (Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø«Ø§Ù†ÙŠ) -->
    <div id="strongResultsTab" class="tab-content" style="display: none;">
        <!-- Ù‚Ø³Ù… Ø¥Ø¶Ø§ÙØ© Ù†ØªÙŠØ¬Ø© Ù‚ÙˆÙŠØ© -->
        <div class="card">
            <h3>ğŸ’ª Ø¥Ø¶Ø§ÙØ© Ù†ØªÙŠØ¬Ø© Ù‚ÙˆÙŠØ©</h3>
            
            <div class="result-inputs">
                <input id="strongWinner" list="playersDatalist" placeholder="ğŸ‘¤ Ø§Ù„ÙØ§Ø¦Ø²">
                <span>VS</span>
                <input id="strongLoser" list="playersDatalist" placeholder="ğŸ‘¤ Ø§Ù„Ø®Ø§Ø³Ø±">
            </div>
            
            <div class="result-inputs">
                <input id="strongScoreWinner" type="number" min="0" max="20" placeholder="0" value="6" style="text-align: center;">
                <span>:</span>
                <input id="strongScoreLoser" type="number" min="0" max="20" placeholder="0" value="1" style="text-align: center;">
            </div>
            
            <select id="strongGameType" onchange="toggleStrongTeamInputs()" style="margin-bottom: 10px;">
                <option value="1v1">ğŸ® 1 Ø¶Ø¯ 1 (ÙØ±Ø¯ÙŠ)</option>
                <option value="2v2">ğŸ‘¥ 2 Ø¶Ø¯ 2 (Ø«Ù†Ø§Ø¦ÙŠ)</option>
            </select>
            
            <!-- Ø­Ù‚ÙˆÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø«Ù†Ø§Ø¦ÙŠ -->
            <div id="strongTeamInputs" style="display: none; margin-bottom: 15px;">
                <div class="result-inputs">
                    <input id="strongWinnerPartner" list="playersDatalist" placeholder="ğŸ‘¤ Ø´Ø±ÙŠÙƒ Ø§Ù„ÙØ§Ø¦Ø²">
                    <span>&</span>
                    <input id="strongLoserPartner" list="playersDatalist" placeholder="ğŸ‘¤ Ø´Ø±ÙŠÙƒ Ø§Ù„Ø®Ø§Ø³Ø±">
                </div>
            </div>
            
            <textarea id="strongNotes" placeholder="ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" rows="2" style="margin-bottom: 15px; resize: vertical;"></textarea>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="saveStrongResult()" class="warning" style="flex: 3;">ğŸ’ª Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù‚ÙˆÙŠØ©</button>
                <button onclick="clearStrongForm()" class="secondary" style="flex: 1;">ğŸ—‘ï¸ Ù…Ø³Ø­</button>
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù‚ÙˆÙŠØ© -->
        <div class="card">
            <h3>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù‚ÙˆÙŠØ©</h3>
            <div class="stats-buttons">
                <button onclick="showStrongStats('1v1')">ğŸ® ÙØ±Ø¯ÙŠ</button>
                <button onclick="showStrongStats('2v2')">ğŸ‘¥ Ø«Ù†Ø§Ø¦ÙŠ</button>
                <button onclick="showStrongStats('all')">ğŸ“ˆ Ø¬Ù…ÙŠØ¹</button>
                <button onclick="showTopStrongPlayers()" class="secondary">ğŸ† Ø§Ù„Ø£Ù‚ÙˆÙ‰</button>
                <button onclick="showStrongHistory()" class="secondary">ğŸ“œ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙƒØ§Ù…Ù„</button>
            </div>
            <div id="strongStatsBox">
                <p style="text-align: center; color: #94a3b8;">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</p>
            </div>
        </div>

        <!-- Ù‚Ø³Ù… ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù‚ÙˆÙŠØ© -->
        <div class="card">
            <h3>ğŸ“‹ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù‚ÙˆÙŠØ©</h3>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div class="info-text">Ø¢Ø®Ø± 10 Ù†ØªØ§Ø¦Ø¬ Ù‚ÙˆÙŠØ©</div>
                <button onclick="loadStrongResults()" class="secondary" style="width: auto;">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
            </div>
            <div id="strongResultsHistory">
                <p style="text-align: center; color: #94a3b8;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù‚ÙˆÙŠØ©...</p>
            </div>
        </div>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø«Ø§Ù„Ø«) -->
    <div id="statsTab" class="tab-content" style="display: none;">
        <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø© -->
        <div class="card">
            <h3>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª</h3>
            <div class="stats-buttons">
                <button onclick="showStats('individual')">ğŸ® ÙØ±Ø¯ÙŠ</button>
                <button onclick="showStats('team')">ğŸ‘¥ Ø«Ù†Ø§Ø¦ÙŠ</button>
                <button onclick="showStats('all')">ğŸ“ˆ Ø¹Ø§Ù…</button>
                <button onclick="showMyStats()" class="secondary">ğŸ‘¤ Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙŠ</button>
                <button onclick="showTopPlayers()" class="secondary">ğŸ† Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</button>
                <button onclick="showHistory()" class="secondary">ğŸ“œ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙƒØ§Ù…Ù„</button>
            </div>
            <div id="statsBox">
                <p style="text-align: center; color: #94a3b8;">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</p>
            </div>
        </div>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© (Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø±Ø§Ø¨Ø¹) -->
    <div id="compareTab" class="tab-content" style="display: none;">
        <!-- Ù‚Ø³Ù… Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† -->
        <div class="card">
            <h3>ğŸ†š Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h3>
            <div class="player-management">
                <select id="playerA">
                    <option value="">ğŸ‘¤ Ø§Ø®ØªØ± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„</option>
                </select>
                <select id="playerB">
                    <option value="">ğŸ‘¤ Ø§Ø®ØªØ± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
                </select>
            </div>
            <select id="compareType" onchange="updateCompareMode()">
                <option value="all">ğŸ® Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª</option>
                <option value="individual">ğŸ® ÙØ±Ø¯ÙŠ ÙÙ‚Ø·</option>
                <option value="team">ğŸ‘¥ Ø«Ù†Ø§Ø¦ÙŠ ÙÙ‚Ø·</option>
            </select>
            <select id="compareElement">
                <option value="total">ğŸ® Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª</option>
                <option value="king">ğŸ‘‘ Ø§Ù„ÙƒÙ†Ø¬</option>
                <option value="bad">ğŸ¤¡ Ø§Ù„Ø¨Ø¹Ø±ÙˆØ±</option>
                <option value="winRate">ğŸ“Š Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ²</option>
                <option value="kingRate">ğŸ‘‘ Ù†Ø³Ø¨Ø© Ø§Ù„ÙƒÙ†Ø¬</option>
                <option value="badRate">ğŸ¤¡ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¨Ø¹Ø±ÙˆØ±</option>
            </select>
            <button onclick="comparePlayers()">Ù…Ù‚Ø§Ø±Ù†Ø©</button>
            <div id="compareResult"></div>
        </div>
    </div>

    <!-- ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø© -->
    <div style="text-align: center; margin-top: 30px; color: #64748b; font-size: 0.9em;">
        <hr style="border-color: #334155; margin: 20px 0;">
        <div>KingBad Stats v3.5 ğŸ‘‘ğŸ¤¡ | ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø¹Ø¨Ø¯Ù„ÙŠ</div>
        <div style="margin-top: 5px;">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2024 | ØªØ®Ø²ÙŠÙ† Ø³Ø­Ø§Ø¨ÙŠ Ø¨Ø­Øª</div>
    </div>
</div>

<script>
// ==================== Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ ÙÙ‚Ø· ====================
// Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
localStorage.clear();

// ==================== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ====================
let USERS = [
    {u:"player1",p:"1234",n:"Ø§Ù„Ù„Ø§Ø¹Ø¨ 1",r:"user"},
    {u:"player2",p:"1234",n:"Ø§Ù„Ù„Ø§Ø¹Ø¨ 2",r:"user"},
    {u:"player3",p:"1234",n:"Ø§Ù„Ù„Ø§Ø¹Ø¨ 3",r:"user"},
    {u:"alabdle",p:"admin123",n:"Ø§Ù„Ø¹Ø¨Ø¯Ù„ÙŠ",r:"admin"}
];

window.competitions = [];
window.strongResults = [];
window.allPlayers = new Set();
window.currentUser = null;
window.deleteMode = false;
window.pendingAction = null;
window.isOnline = navigator.onLine;
window.firebaseEnabled = true;
window.isSaving = false;
window.firebaseCollections = {
    competitions: 'competitions',
    strongResults: 'strongResults'
};

// ==================== Ø¯Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ====================
function showToast(message, type = 'info', duration = 3000) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast ${type}`;
    toast.style.display = 'block';
    
    setTimeout(() => {
        toast.style.display = 'none';
    }, duration);
}

function updateSaveButtonState(isSaving) {
    const saveButton = document.getElementById('saveButton');
    if (isSaving) {
        saveButton.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
        saveButton.disabled = true;
        saveButton.style.opacity = '0.7';
        saveButton.style.cursor = 'not-allowed';
    } else {
        saveButton.innerHTML = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±ÙŠ';
        saveButton.disabled = false;
        saveButton.style.opacity = '1';
        saveButton.style.cursor = 'pointer';
    }
}

function updateSyncStatus(text, status) {
    const statusElement = document.getElementById('syncStatus');
    const textElement = document.getElementById('syncStatusText');
    
    if (statusElement && textElement) {
        statusElement.style.display = 'block';
        textElement.textContent = text;
        textElement.className = status;
    }
}

function showConfirmModal(title, message, callback) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalMessage').textContent = message;
    document.getElementById('confirmModal').style.display = 'flex';
    window.pendingAction = callback;
}

window.confirmAction = function(confirmed) {
    document.getElementById('confirmModal').style.display = 'none';
    if (confirmed && window.pendingAction) window.pendingAction();
    window.pendingAction = null;
};

// ==================== Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ====================
function showTab(tabName) {
    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    document.getElementById('competitionsTab').style.display = 'none';
    document.getElementById('strongResultsTab').style.display = 'none';
    document.getElementById('statsTab').style.display = 'none';
    document.getElementById('compareTab').style.display = 'none';
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø· Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    document.getElementById('tabCompetitions').classList.remove('active');
    document.getElementById('tabStrongResults').classList.remove('active');
    document.getElementById('tabStats').classList.remove('active');
    document.getElementById('tabCompare').classList.remove('active');
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
    document.getElementById(tabName + 'Tab').style.display = 'block';
    const tabButton = document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
    if (tabButton) {
        tabButton.classList.add('active');
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
    if (tabName === 'strongResults') {
        loadStrongResults();
    } else if (tabName === 'stats') {
        updatePlayersLists();
    } else if (tabName === 'compare') {
        updatePlayersLists();
    }
}

// ==================== Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø¯Ù…Ù† ====================
window.toggleAdminPanel = function() {
    const panel = document.getElementById('adminPanel');
    panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
};

window.toggleDeleteMode = function() {
    if (!currentUser || currentUser.role !== "admin") {
        showToast("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„", "error");
        return;
    }
    
    window.deleteMode = !window.deleteMode;
    
    // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø°Ù
    const items = document.querySelectorAll('.competition-item');
    items.forEach(item => {
        if (window.deleteMode) {
            item.classList.add('admin-visible');
        } else {
            item.classList.remove('admin-visible');
        }
    });
    
    showToast(window.deleteMode ? "âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø°Ù" : "âŒ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø°Ù");
};

// ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª ====================
function switchMode() {
    const type = document.getElementById('type').value;
    document.getElementById('individualBox').style.display = type === "individual" ? "block" : "none";
    document.getElementById('teamBox').style.display = type === "team" ? "block" : "none";
}

async function saveCompetition() {
    // Ù…Ù†Ø¹ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
    if (window.isSaving) {
        showToast("â³ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...", "warning");
        return;
    }
    
    let players = [];
    const type = document.getElementById('type').value;
    
    if (type === "individual") {
        document.querySelectorAll("#individuals input").forEach(i => {
            const name = i.value.trim();
            if (name) players.push(name);
        });
    } else {
        document.querySelectorAll("#teams div").forEach(r => {
            const a = r.children[0].value.trim();
            const b = r.children[1].value.trim();
            if (a && b) players.push(`${a} & ${b}`);
        });
    }
    
    if (players.length < 2) {
        showToast("âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„", "warning");
        return;
    }
    
    if (!currentUser) {
        showToast("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹", "error");
        return;
    }
    
    if (!window.isOnline) {
        showToast("âŒ ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª", "error");
        return;
    }
    
    const now = new Date();
    const competitionData = {
        players: players,
        addedBy: currentUser.username,
        addedByName: currentUser.name,
        timestamp: now.toISOString(),
        date: now.toLocaleDateString('ar-SA'),
        time: now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })
    };
    
    try {
        window.isSaving = true;
        updateSaveButtonState(true);
        updateSyncStatus("ğŸ’¾ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±ÙŠ...", "syncing");
        
        // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
        const firebaseId = await saveToCloud('competitions', competitionData);
        
        if (firebaseId) {
            competitionData.firebaseId = firebaseId;
            window.competitions.unshift(competitionData);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            updateAppStats();
            displayCompetitionsHistory();
            updatePlayersLists();
            
            showToast(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±ÙŠ: ${players.join('ØŒ ')}`);
            clearForm();
            updateSyncStatus("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸", "online");
        }
        
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±ÙŠ:", error);
        showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±ÙŠ: " + error.message, "error");
        updateSyncStatus("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸", "error");
    } finally {
        window.isSaving = false;
        updateSaveButtonState(false);
    }
}

function updateAppStats() {
    if (!window.competitions) {
        window.competitions = [];
    }
    
    document.getElementById('totalCompetitions').textContent = window.competitions.length;
    
    // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„ÙØ±ÙŠØ¯ÙŠÙ†
    const uniquePlayers = new Set();
    window.competitions.forEach(c => {
        if (c.players && Array.isArray(c.players)) {
            c.players.forEach(p => {
                if (p.includes(" & ")) {
                    p.split(" & ").forEach(pl => {
                        const trimmed = pl.trim();
                        if (trimmed) uniquePlayers.add(trimmed);
                    });
                } else {
                    const trimmed = p.trim();
                    if (trimmed) uniquePlayers.add(trimmed);
                }
            });
        }
    });
    
    document.getElementById('totalPlayers').textContent = uniquePlayers.size;
}

function displayCompetitionsHistory() {
    const historyElement = document.getElementById('competitionsHistory');
    
    if (!window.competitions || window.competitions.length === 0) {
        historyElement.innerHTML = '<p style="text-align: center; color: #94a3b8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙˆØ±ÙŠØ§Øª</p>';
        return;
    }
    
    const recent = window.competitions.slice(0, 15);
    let html = '';
    
    recent.forEach(c => {
        const deleteBtn = (currentUser?.role === "admin" && window.deleteMode) ? 
            `<button class="delete-btn" onclick="deleteCompetition('${c.firebaseId}')" title="Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±ÙŠ">Ã—</button>` : '';
        
        const players = c.players ? c.players.join('ØŒ ') : 'Ù„Ø§Ø¹Ø¨ÙˆÙ† ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙÙŠÙ†';
        
        html += `
            <div class="competition-item ${(currentUser?.role === "admin" && window.deleteMode) ? "admin-visible" : ""}">
                ${deleteBtn}
                <div style="margin-bottom: 8px;">
                    <strong>ğŸ‘¥ ${players}</strong>
                </div>
                <div style="font-size: 0.9em;">
                    <span class="user-badge">ğŸ‘¤ ${c.addedByName || 'Ù…Ø¬Ù‡ÙˆÙ„'}</span>
                    <span class="time-badge">ğŸ“… ${c.date || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</span>
                    <span class="time-badge">â° ${c.time || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</span>
                </div>
            </div>
        `;
    });
    
    historyElement.innerHTML = html;
}

async function deleteCompetition(firebaseId) {
    if (!currentUser || currentUser.role !== "admin") {
        showToast("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø­Ø°Ù", "error");
        return;
    }
    
    showConfirmModal("Ø­Ø°Ù Ø¯ÙˆØ±ÙŠ", "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ±ÙŠØŸ", async () => {
        try {
            await deleteFromCloud('competitions', firebaseId);
            window.competitions = window.competitions.filter(c => c.firebaseId !== firebaseId);
            updateAppStats();
            displayCompetitionsHistory();
            updatePlayersLists();
            showToast("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±ÙŠ");
        } catch (error) {
            console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±ÙŠ:", error);
            showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±ÙŠ", "error");
        }
    });
}

// ==================== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø¯ÙˆØ±ÙŠØ§Øª ====================
function addIndividual() {
    const div = document.createElement('div');
    div.innerHTML = `<input list="playersDatalist" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨">`;
    document.getElementById('individuals').appendChild(div);
}

function addTeam() {
    const div = document.createElement('div');
    div.innerHTML = `
        <input list="playersDatalist" placeholder="Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„">
        <input list="playersDatalist" placeholder="Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ">
    `;
    document.getElementById('teams').appendChild(div);
}

function clearForm() {
    document.querySelectorAll("#individuals input").forEach(i => i.value = "");
    document.querySelectorAll("#teams input").forEach(i => i.value = "");
    document.getElementById('individuals').innerHTML = '';
    document.getElementById('teams').innerHTML = '';
    addIndividual();
    addIndividual();
}

function quickAddPlayers() {
    const commonPlayers = ['Ø§Ù„Ø¹Ø¨Ø¯Ù„ÙŠ', 'Ù…Ø­Ù…Ø¯', 'Ø£Ø­Ù…Ø¯', 'Ø®Ø§Ù„Ø¯', 'Ø¹Ù…Ø±', 'Ø¹Ù„ÙŠ'];
    const container = document.getElementById('individuals');
    container.innerHTML = '';
    
    commonPlayers.forEach(player => {
        const div = document.createElement('div');
        div.innerHTML = `<input list="playersDatalist" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨" value="${player}">`;
        container.appendChild(div);
    });
}

function updatePlayersLists() {
    const datalist = document.getElementById('playersDatalist');
    const playerA = document.getElementById('playerA');
    const playerB = document.getElementById('playerB');
    
    const allPlayers = getAllPlayers();
    
    datalist.innerHTML = '';
    playerA.innerHTML = '<option value="">ğŸ‘¤ Ø§Ø®ØªØ± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„</option>';
    playerB.innerHTML = '<option value="">ğŸ‘¤ Ø§Ø®ØªØ± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>';
    
    allPlayers.forEach(player => {
        datalist.innerHTML += `<option value="${player}">`;
        playerA.innerHTML += `<option value="${player}">${player}</option>`;
        playerB.innerHTML += `<option value="${player}">${player}</option>`;
    });
}

// ==================== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø© ====================
function showStats(type) {
    const stats = calculateStats(type);
    const statsBox = document.getElementById('statsBox');
    
    let title = type === 'individual' ? "ğŸ® Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙØ±Ø¯ÙŠØ©" : 
                type === 'team' ? "ğŸ‘¥ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙØ±Ù‚" : "ğŸ“ˆ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©";
    
    let html = `<h4>${title}</h4>`;
    
    if (Object.keys(stats).length === 0) {
        html += '<p style="color: #94a3b8; text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
    } else {
        const sorted = Object.entries(stats).sort((a,b) => b[1].total - a[1].total);
        
        sorted.forEach(([player, data]) => {
            const winRate = data.total > 0 ? ((data.king / data.total) * 100).toFixed(1) : 0;
            const lossRate = data.total > 0 ? ((data.bad / data.total) * 100).toFixed(1) : 0;
            
            html += `
                <div class="stat-card">
                    <div style="margin-bottom: 15px;">
                        <strong style="font-size: 1.1em;">${player}</strong>
                        <div style="font-size: 0.85em; color: #94a3b8; margin-top: 5px;">
                            <span class="user-badge">ğŸ® ${data.total} Ù…Ø¨Ø§Ø±Ø§Ø©</span>
                        </div>
                    </div>
                    
                    <div class="stats-row">
                        <span>ğŸ‘‘ Ø§Ù„ÙƒÙ†Ø¬:</span>
                        <div>
                            <span style="color: #fbbf24; font-weight: bold;">${data.king}</span>
                            <span class="rate-badge" style="margin-right: 8px;">${((data.king / data.total) * 100).toFixed(1)}%</span>
                        </div>
                    </div>
                    
                    <div class="stats-row">
                        <span>ğŸ¤¡ Ø§Ù„Ø¨Ø¹Ø±ÙˆØ±:</span>
                        <div>
                            <span style="color: #ef4444; font-weight: bold;">${data.bad}</span>
                            <span class="rate-badge" style="margin-right: 8px; background: #ef4444;">${((data.bad / data.total) * 100).toFixed(1)}%</span>
                        </div>
                    </div>
                    
                    <div class="stats-row">
                        <span>ğŸ“Š Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ²:</span>
                        <span style="color: #22c55e; font-weight: bold;">${winRate}%</span>
                    </div>
                    
                    <div class="progress-bar" style="margin-top: 15px;">
                        <div class="progress" style="width: ${winRate}%;"></div>
                    </div>
                </div>
            `;
        });
    }
    
    statsBox.innerHTML = html;
}

function calculateStats(filterType) {
    let stats = {};
    
    if (!window.competitions || !Array.isArray(window.competitions)) {
        return stats;
    }
    
    window.competitions.forEach(c => {
        // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙˆØ±ÙŠ
        let isTeam = false;
        if (c.players && Array.isArray(c.players) && c.players.length > 0) {
            isTeam = c.players[0].includes(" & ");
        }
        
        const type = isTeam ? "team" : "individual";
        
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±
        if (filterType !== "all" && filterType !== type) return;
        
        const first = c.players[0];
        const last = c.players[c.players.length - 1];
        
        // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
        c.players.forEach(player => {
            let playersList = [];
            if (player.includes(" & ")) {
                playersList = player.split(" & ").map(p => p.trim());
            } else {
                playersList = [player.trim()];
            }
            
            playersList.forEach(p => {
                if (!p) return;
                if (!stats[p]) stats[p] = {total:0, king:0, bad:0};
                stats[p].total++;
            });
        });
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙ†Ø¬
        let firstPlayers = [];
        if (first.includes(" & ")) {
            firstPlayers = first.split(" & ").map(p => p.trim());
        } else {
            firstPlayers = [first.trim()];
        }
        
        firstPlayers.forEach(p => { 
            if (p && stats[p]) stats[p].king++; 
        });
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø¹Ø±ÙˆØ±
        let lastPlayers = [];
        if (last.includes(" & ")) {
            lastPlayers = last.split(" & ").map(p => p.trim());
        } else {
            lastPlayers = [last.trim()];
        }
        
        lastPlayers.forEach(p => { 
            if (p && stats[p]) stats[p].bad++; 
        });
    });
    
    return stats;
}

window.showMyStats = function() {
    if (!currentUser) {
        showToast("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹", "error");
        return;
    }
    
    const stats = calculateStats('all');
    const myStats = stats[currentUser.name] || { total: 0, king: 0, bad: 0 };
    const myCompetitions = window.competitions.filter(c => c.addedBy === currentUser.username);
    
    let html = `<h4>ğŸ‘¤ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ${currentUser.name}</h4>`;
    
    const winRate = myStats.total > 0 ? ((myStats.king / myStats.total) * 100).toFixed(1) : 0;
    const lossRate = myStats.total > 0 ? ((myStats.bad / myStats.total) * 100).toFixed(1) : 0;
    
    html += `
        <div class="stat-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center; margin-bottom: 20px;">
                <div>
                    <div style="font-size: 1.5em; font-weight: bold; color: #22c55e;">${myStats.total}</div>
                    <div style="font-size: 0.9em; color: #94a3b8;">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª</div>
                </div>
                <div>
                    <div style="font-size: 1.5em; font-weight: bold; color: #3b82f6;">${myCompetitions.length}</div>
                    <div style="font-size: 0.9em; color: #94a3b8;">Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ©</div>
                </div>
            </div>
            
            <div class="stats-row">
                <span>ğŸ‘‘ Ø§Ù„ÙƒÙ†Ø¬:</span>
                <div>
                    <span style="color: #fbbf24; font-weight: bold;">${myStats.king}</span>
                    <span class="rate-badge">${myStats.total > 0 ? ((myStats.king / myStats.total) * 100).toFixed(1) : 0}%</span>
                </div>
            </div>
            
            <div class="stats-row">
                <span>ğŸ¤¡ Ø§Ù„Ø¨Ø¹Ø±ÙˆØ±:</span>
                <div>
                    <span style="color: #ef4444; font-weight: bold;">${myStats.bad}</span>
                    <span class="rate-badge" style="background: #ef4444;">${myStats.total > 0 ? ((myStats.bad / myStats.total) * 100).toFixed(1) : 0}%</span>
                </div>
            </div>
            
            <div class="stats-row">
                <span>ğŸ“Š Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ²:</span>
                <span style="color: #22c55e; font-weight: bold;">${winRate}%</span>
            </div>
            
            <div class="progress-bar" style="margin-top: 15px;">
                <div class="progress" style="width: ${winRate}%;"></div>
            </div>
        </div>
    `;
    
    if (myCompetitions.length > 0) {
        html += '<h5 style="margin-top: 20px;">ğŸ“ Ø¢Ø®Ø± Ø¯ÙˆØ±ÙŠØ§ØªÙŠ:</h5>';
        myCompetitions.slice(0, 5).forEach(comp => {
            const players = comp.players ? comp.players.join('ØŒ ') : 'Ù„Ø§Ø¹Ø¨ÙˆÙ† ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙÙŠÙ†';
            html += `
                <div class="competition-item">
                    <div style="margin-bottom: 8px;">
                        <strong>ğŸ‘¥ ${players}</strong>
                    </div>
                    <div style="font-size: 0.85em; color: #94a3b8;">
                        <span class="time-badge">ğŸ“… ${comp.date || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</span>
                        <span class="time-badge">â° ${comp.time || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</span>
                    </div>
                </div>
            `;
        });
    }
    
    document.getElementById('statsBox').innerHTML = html;
};

window.showTopPlayers = function() {
    const stats = calculateStats('all');
    const sorted = Object.entries(stats).sort((a,b) => {
        // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ†Ø¬ Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ²
        if (b[1].king !== a[1].king) return b[1].king - a[1].king;
        const aWinRate = a[1].total > 0 ? (a[1].king / a[1].total) : 0;
        const bWinRate = b[1].total > 0 ? (b[1].king / b[1].total) : 0;
        return bWinRate - aWinRate;
    }).slice(0, 10);
    
    let html = '<h4>ğŸ† Ø£ÙØ¶Ù„ 10 Ù„Ø§Ø¹Ø¨ÙŠÙ†</h4>';
    
    if (sorted.length === 0) {
        html += '<p style="color: #94a3b8; text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
    } else {
        sorted.forEach(([player, data], index) => {
            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ğŸ”Ÿ'];
            const medal = medals[index] || 'ğŸ–ï¸';
            const winRate = data.total > 0 ? ((data.king / data.total) * 100).toFixed(1) : 0;
            const lossRate = data.total > 0 ? ((data.bad / data.total) * 100).toFixed(1) : 0;
            
            html += `
                <div class="competition-item">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <strong>${medal} ${player}</strong>
                            <div style="font-size: 0.85em; color: #94a3b8; margin-top: 5px;">
                                <span class="user-badge">ğŸ® ${data.total} Ù…Ø¨Ø§Ø±Ø§Ø©</span>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #22c55e; font-weight: bold;">${winRate}%</div>
                            <div style="font-size: 0.8em; color: #94a3b8;">Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ²</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center;">
                        <div>
                            <div style="font-size: 1em; font-weight: bold; color: #fbbf24;">${data.king}</div>
                            <div style="font-size: 0.8em; color: #94a3b8;">ğŸ‘‘ Ø§Ù„ÙƒÙ†Ø¬</div>
                        </div>
                        <div>
                            <div style="font-size: 1em; font-weight: bold; color: #ef4444;">${data.bad}</div>
                            <div style="font-size: 0.8em; color: #94a3b8;">ğŸ¤¡ Ø§Ù„Ø¨Ø¹Ø±ÙˆØ±</div>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    document.getElementById('statsBox').innerHTML = html;
};

window.showHistory = function() {
    const statsBox = document.getElementById('statsBox');
    
    if (!window.competitions || window.competitions.length === 0) {
        statsBox.innerHTML = '<p style="color: #94a3b8; text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙˆØ±ÙŠØ§Øª</p>';
        return;
    }
    
    let html = '<h4>ğŸ“œ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª</h4>';
    
    window.competitions.forEach(c => {
        const deleteBtn = (currentUser?.role === "admin" && window.deleteMode) ? 
            `<button class="delete-btn" onclick="deleteCompetition('${c.firebaseId}')" title="Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±ÙŠ">Ã—</button>` : '';
        
        const players = c.players ? c.players.join('ØŒ ') : 'Ù„Ø§Ø¹Ø¨ÙˆÙ† ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙÙŠÙ†';
        
        html += `
            <div class="competition-item ${(currentUser?.role === "admin" && window.deleteMode) ? "admin-visible" : ""}">
                ${deleteBtn}
                <div style="margin-bottom: 8px;">
                    <strong>ğŸ‘¥ ${players}</strong>
                </div>
                <div style="font-size: 0.85em;">
                    <span class="user-badge">ğŸ‘¤ ${c.addedByName || 'Ù…Ø¬Ù‡ÙˆÙ„'}</span>
                    <span class="time-badge">ğŸ“… ${c.date || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</span>
                    <span class="time-badge">â° ${c.time || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</span>
                </div>
            </div>
        `;
    });
    
    statsBox.innerHTML = html;
};

// ==================== Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø© ====================
function updateCompareMode() {
    const compareType = document.getElementById('compareType').value;
    updatePlayersLists();
}

window.comparePlayers = function() {
    const playerA = document.getElementById('playerA').value;
    const playerB = document.getElementById('playerB').value;
    const compareType = document.getElementById('compareType').value;
    const element = document.getElementById('compareElement').value;
    
    if (!playerA || !playerB) {
        showToast("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©", "warning");
        return;
    }
    
    if (playerA === playerB) {
        showToast("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù…Ø®ØªÙ„ÙÙŠÙ†", "warning");
        return;
    }
    
    const stats = calculateStats(compareType);
    const aStats = stats[playerA] || { total: 0, king: 0, bad: 0 };
    const bStats = stats[playerB] || { total: 0, king: 0, bad: 0 };
    
    const aWinRate = aStats.total > 0 ? ((aStats.king / aStats.total) * 100).toFixed(1) : 0;
    const bWinRate = bStats.total > 0 ? ((bStats.king / bStats.total) * 100).toFixed(1) : 0;
    const aKingRate = aStats.total > 0 ? ((aStats.king / aStats.total) * 100).toFixed(1) : 0;
    const bKingRate = bStats.total > 0 ? ((bStats.king / bStats.total) * 100).toFixed(1) : 0;
    const aBadRate = aStats.total > 0 ? ((aStats.bad / aStats.total) * 100).toFixed(1) : 0;
    const bBadRate = bStats.total > 0 ? ((bStats.bad / bStats.total) * 100).toFixed(1) : 0;
    
    let aValue, bValue, aLabel, bLabel;
    switch(element) {
        case 'total': 
            aValue = aStats.total; 
            bValue = bStats.total;
            aLabel = 'ğŸ® Ù…Ø¨Ø§Ø±Ø§Ø©';
            bLabel = 'ğŸ® Ù…Ø¨Ø§Ø±Ø§Ø©';
            break;
        case 'king': 
            aValue = aStats.king; 
            bValue = bStats.king;
            aLabel = 'ğŸ‘‘ ÙƒÙ†Ø¬';
            bLabel = 'ğŸ‘‘ ÙƒÙ†Ø¬';
            break;
        case 'bad': 
            aValue = aStats.bad; 
            bValue = bStats.bad;
            aLabel = 'ğŸ¤¡ Ø¨Ø¹Ø±ÙˆØ±';
            bLabel = 'ğŸ¤¡ Ø¨Ø¹Ø±ÙˆØ±';
            break;
        case 'winRate': 
            aValue = parseFloat(aWinRate); 
            bValue = parseFloat(bWinRate);
            aLabel = 'ğŸ“Š %';
            bLabel = 'ğŸ“Š %';
            break;
        case 'kingRate': 
            aValue = parseFloat(aKingRate); 
            bValue = parseFloat(bKingRate);
            aLabel = 'ğŸ‘‘ %';
            bLabel = 'ğŸ‘‘ %';
            break;
        case 'badRate': 
            aValue = parseFloat(aBadRate); 
            bValue = parseFloat(bBadRate);
            aLabel = 'ğŸ¤¡ %';
            bLabel = 'ğŸ¤¡ %';
            break;
    }
    
    let winner = "";
    let winnerClass = "";
    if (aValue > bValue) {
        const diff = (aValue - bValue).toFixed(1);
        winner = `${playerA} ÙŠØªÙÙˆÙ‚ Ø¨Ù€ ${diff}${element.includes('Rate') ? '%' : ''}`;
        winnerClass = "winner";
    } else if (bValue > aValue) {
        const diff = (bValue - aValue).toFixed(1);
        winner = `${playerB} ÙŠØªÙÙˆÙ‚ Ø¨Ù€ ${diff}${element.includes('Rate') ? '%' : ''}`;
        winnerClass = "loser";
    } else {
        winner = "ØªØ¹Ø§Ø¯Ù„ ØªØ§Ù…";
        winnerClass = "draw";
    }
    
    const compareTypeText = compareType === 'individual' ? 'ÙØ±Ø¯ÙŠ' : 
                          compareType === 'team' ? 'Ø«Ù†Ø§Ø¦ÙŠ' : 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª';
    
    const compareResult = document.getElementById('compareResult');
    compareResult.innerHTML = `
        <div style="text-align: center;">
            <h4>ğŸ†š Ù…Ù‚Ø§Ø±Ù†Ø© ${compareTypeText}</h4>
            <div style="display: flex; justify-content: space-around; margin: 20px 0;">
                <div style="text-align: center;">
                    <div style="font-size: 2em; font-weight: bold; color: #22c55e;">${aValue}${element.includes('Rate') ? '%' : ''}</div>
                    <div style="font-size: 1.1em;">${playerA}</div>
                    <div style="font-size: 0.85em; color: #94a3b8; margin-top: 5px;">
                        ${aLabel}
                    </div>
                </div>
                <div style="align-self: center; font-size: 1.5em;">VS</div>
                <div style="text-align: center;">
                    <div style="font-size: 2em; font-weight: bold; color: #3b82f6;">${bValue}${element.includes('Rate') ? '%' : ''}</div>
                    <div style="font-size: 1.1em;">${playerB}</div>
                    <div style="font-size: 0.85em; color: #94a3b8; margin-top: 5px;">
                        ${bLabel}
                    </div>
                </div>
            </div>
            
            <div style="background: #1e293b; padding: 15px; border-radius: 8px; margin-top: 15px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div style="text-align: center;">
                        <div style="color: #fbbf24;">ğŸ‘‘ ${aStats.king} (${aKingRate}%)</div>
                        <div style="font-size: 0.8em; color: #94a3b8;">${playerA}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #fbbf24;">ğŸ‘‘ ${bStats.king} (${bKingRate}%)</div>
                        <div style="font-size: 0.8em; color: #94a3b8;">${playerB}</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div style="text-align: center;">
                        <div style="color: #ef4444;">ğŸ¤¡ ${aStats.bad} (${aBadRate}%)</div>
                        <div style="font-size: 0.8em; color: #94a3b8;">${playerA}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #ef4444;">ğŸ¤¡ ${bStats.bad} (${bBadRate}%)</div>
                        <div style="font-size: 0.8em; color: #94a3b8;">${playerB}</div>
                    </div>
                </div>
                
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #334155;">
                    <div style="color: #94a3b8; font-size: 0.9em;">
                        Ù†ÙˆØ¹ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©: <strong>${compareTypeText}</strong>
                    </div>
                </div>
            </div>
            
            <div class="compare-result" style="margin-top: 15px;">
                <div class="${winnerClass}" style="font-size: 1.2em; margin-bottom: 10px;">ğŸ† Ø§Ù„Ù†ØªÙŠØ¬Ø©</div>
                <div style="font-size: 1.1em; font-weight: bold;">${winner}</div>
                <div style="font-size: 0.9em; color: #94a3b8; margin-top: 5px;">
                    ${aStats.total} vs ${bStats.total} Ù…Ø¨Ø§Ø±Ø§Ø©
                </div>
            </div>
        </div>
    `;
};

// ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù‚ÙˆÙŠØ© Ø§Ù„Ù…Ù†ÙØµÙ„ ====================
function toggleStrongTeamInputs() {
    const gameType = document.getElementById('strongGameType').value;
    document.getElementById('strongTeamInputs').style.display = gameType === '2v2' ? 'block' : 'none';
}

async function loadStrongResults() {
    try {
        const cloudData = await loadFromCloud('strongResults');
        if (cloudData?.strongResults) {
            window.strongResults = cloudData.strongResults;
            displayStrongResultsHistory();
        } else {
            window.strongResults = [];
            displayStrongResultsHistory();
        }
    } catch (error) {
        console.error("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù‚ÙˆÙŠØ©:", error);
        window.strongResults = [];
        displayStrongResultsHistory();
    }
}

async function saveStrongResult() {
    const winner = document.getElementById('strongWinner').value.trim();
    const loser = document.getElementById('strongLoser').value.trim();
    const scoreWinner = parseInt(document.getElementById('strongScoreWinner').value) || 0;
    const scoreLoser = parseInt(document.getElementById('strongScoreLoser').value) || 0;
    const gameType = document.getElementById('strongGameType').value;
    const notes = document.getElementById('strongNotes').value.trim();
    
    let winnerPartner = '';
    let loserPartner = '';
    
    if (gameType === '2v2') {
        winnerPartner = document.getElementById('strongWinnerPartner').value.trim();
        loserPartner = document.getElementById('strongLoserPartner').value.trim();
        
        if (!winnerPartner || !loserPartner) {
            showToast("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø´Ø±ÙƒØ§Ø¡ Ù„Ù„Ø«Ù†Ø§Ø¦ÙŠ", "warning");
            return;
        }
    }
    
    if (!winner || !loser) {
        showToast("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†", "warning");
        return;
    }
    
    if (winner === loser || (gameType === '2v2' && (winner === loserPartner || loser === winnerPartner))) {
        showToast("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¶Ø¯ Ù†ÙØ³Ù‡", "warning");
        return;
    }
    
    if (scoreWinner <= 0 || scoreLoser < 0) {
        showToast("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†ØªØ§Ø¦Ø¬ ØµØ­ÙŠØ­Ø©", "warning");
        return;
    }
    
    if (!currentUser) {
        showToast("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹", "error");
        return;
    }
    
    if (!window.isOnline) {
        showToast("âŒ ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª", "error");
        return;
    }
    
    try {
        updateSyncStatus("ğŸ’ª Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù‚ÙˆÙŠØ©...", "syncing");
        
        const now = new Date();
        const strongResultData = {
            winner: winner,
            loser: loser,
            scoreWinner: scoreWinner,
            scoreLoser: scoreLoser,
            gameType: gameType,
            notes: notes,
            addedBy: currentUser.username,
            addedByName: currentUser.name,
            timestamp: now.toISOString(),
            date: now.toLocaleDateString('ar-SA'),
            time: now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })
        };
        
        if (gameType === '2v2') {
            strongResultData.winnerPartner = winnerPartner;
            strongResultData.loserPartner = loserPartner;
        }
        
        // Ø­Ø³Ø§Ø¨ Ù‚ÙˆØ© Ø§Ù„Ù†ØªÙŠØ¬Ø©
        const totalGames = scoreWinner + scoreLoser;
        const winPercentage = ((scoreWinner / totalGames) * 100).toFixed(1);
        strongResultData.strength = winPercentage;
        
        // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
        const firebaseId = await saveToCloud('strongResults', strongResultData);
        
        if (firebaseId) {
            strongResultData.firebaseId = firebaseId;
            window.strongResults.unshift(strongResultData);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            displayStrongResultsHistory();
            updatePlayersLists();
            
            updateSyncStatus("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸", "online");
            showToast(`ğŸ’ª ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù‚ÙˆÙŠØ©: ${winner} ${scoreWinner}-${scoreLoser} ${loser}`);
            clearStrongForm();
        }
        
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù‚ÙˆÙŠØ©:", error);
        updateSyncStatus("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸", "error");
        showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù‚ÙˆÙŠØ©: " + error.message, "error");
    }
}

function clearStrongForm() {
    document.getElementById('strongWinner').value = '';
    document.getElementById('strongLoser').value = '';
    document.getElementById('strongScoreWinner').value = '6';
    document.getElementById('strongScoreLoser').value = '1';
    document.getElementById('strongGameType').value = '1v1';
    document.getElementById('strongWinnerPartner').value = '';
    document.getElementById('strongLoserPartner').value = '';
    document.getElementById('strongNotes').value = '';
    document.getElementById('strongTeamInputs').style.display = 'none';
}

function displayStrongResultsHistory() {
    const historyElement = document.getElementById('strongResultsHistory');
    
    if (!window.strongResults || window.strongResults.length === 0) {
        historyElement.innerHTML = '<p style="text-align: center; color: #94a3b8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù‚ÙˆÙŠØ©</p>';
        return;
    }
    
    const recent = window.strongResults.slice(0, 10);
    let html = '';
    
    recent.forEach(sr => {
        const deleteBtn = (currentUser?.role === "admin" && window.deleteMode) ? 
            `<button class="delete-btn" onclick="deleteStrongResult('${sr.firebaseId}')" title="Ø­Ø°Ù Ø§Ù„Ù†ØªÙŠØ¬Ø©">Ã—</button>` : '';
        
        const strengthBadge = sr.strength > 80 ? `<span class="strong-badge">ğŸ’ª ${sr.strength}%</span>` : '';
        
        html += `
            <div class="competition-item strong-result-item ${(currentUser?.role === "admin" && window.deleteMode) ? "admin-visible" : ""}">
                ${deleteBtn}
                
                <div style="margin-bottom: 10px;">
                    <div class="score-display">
                        <span class="winner">${sr.winner} ${sr.scoreWinner}</span>
                        <span class="vs">-</span>
                        <span class="loser">${sr.scoreLoser} ${sr.loser}</span>
                    </div>
                    
                    ${sr.gameType === '2v2' ? `
                    <div style="text-align: center; font-size: 0.85em; color: #94a3b8; margin-top: 5px;">
                        Ù…Ø¹ ${sr.winnerPartner} & ${sr.loserPartner}
                    </div>
                    ` : ''}
                </div>
                
                <div style="font-size: 0.85em;">
                    <span class="user-badge">${sr.gameType === '1v1' ? 'ğŸ® ÙØ±Ø¯ÙŠ' : 'ğŸ‘¥ Ø«Ù†Ø§Ø¦ÙŠ'}</span>
                    <span class="user-badge">ğŸ‘¤ ${sr.addedByName || 'Ù…Ø¬Ù‡ÙˆÙ„'}</span>
                    <span class="time-badge">ğŸ“… ${sr.date || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</span>
                    ${strengthBadge}
                </div>
                
                ${sr.notes ? `
                <div style="margin-top: 8px; padding: 8px; background: #1e293b; border-radius: 5px; font-size: 0.85em; color: #94a3b8;">
                    ğŸ“ ${sr.notes}
                </div>
                ` : ''}
            </div>
        `;
    });
    
    historyElement.innerHTML = html;
}

async function deleteStrongResult(firebaseId) {
    if (!currentUser || currentUser.role !== "admin") {
        showToast("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø­Ø°Ù", "error");
        return;
    }
    
    showConfirmModal("Ø­Ø°Ù Ù†ØªÙŠØ¬Ø© Ù‚ÙˆÙŠØ©", "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù‚ÙˆÙŠØ©ØŸ", async () => {
        try {
            await deleteFromCloud('strongResults', firebaseId);
            window.strongResults = window.strongResults.filter(sr => sr.firebaseId !== firebaseId);
            displayStrongResultsHistory();
            showToast("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù‚ÙˆÙŠØ©");
        } catch (error) {
            console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù†ØªÙŠØ¬Ø©:", error);
            showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù†ØªÙŠØ¬Ø©", "error");
        }
    });
}

window.showStrongStats = function(type) {
    let filteredResults = window.strongResults || [];
    
    if (type !== 'all') {
        filteredResults = filteredResults.filter(sr => sr.gameType === type);
    }
    
    const statsBox = document.getElementById('strongStatsBox');
    
    if (!filteredResults || filteredResults.length === 0) {
        statsBox.innerHTML = '<p style="color: #94a3b8; text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù‚ÙˆÙŠØ©</p>';
        return;
    }
    
    let html = `<h4>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù‚ÙˆÙŠØ© ${type === '1v1' ? '(ÙØ±Ø¯ÙŠ)' : type === '2v2' ? '(Ø«Ù†Ø§Ø¦ÙŠ)' : '(Ø¬Ù…ÙŠØ¹)'}</h4>`;
    
    // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø©
    const totalMatches = filteredResults.length;
    const totalPlayers = new Set();
    const totalGames = filteredResults.reduce((sum, sr) => sum + (sr.scoreWinner || 0) + (sr.scoreLoser || 0), 0);
    const avgStrength = (filteredResults.reduce((sum, sr) => sum + parseFloat(sr.strength || 0), 0) / totalMatches).toFixed(1);
    
    filteredResults.forEach(sr => {
        if (sr.winner) totalPlayers.add(sr.winner);
        if (sr.loser) totalPlayers.add(sr.loser);
        if (sr.winnerPartner) totalPlayers.add(sr.winnerPartner);
        if (sr.loserPartner) totalPlayers.add(sr.loserPartner);
    });
    
    html += `
        <div class="stat-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center; margin-bottom: 15px;">
                <div>
                    <div style="font-size: 1.5em; font-weight: bold; color: #f59e0b;">${totalMatches}</div>
                    <div style="font-size: 0.8em; color: #94a3b8;">Ù…Ø¨Ø§Ø±Ø§Ø©</div>
                </div>
                <div>
                    <div style="font-size: 1.5em; font-weight: bold; color: #3b82f6;">${totalPlayers.size}</div>
                    <div style="font-size: 0.8em; color: #94a3b8;">Ù„Ø§Ø¹Ø¨</div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
                <div>
                    <div style="font-size: 1.2em; font-weight: bold; color: #22c55e;">${totalGames}</div>
                    <div style="font-size: 0.8em; color: #94a3b8;">Ø¬ÙˆÙ„Ø©</div>
                </div>
                <div>
                    <div style="font-size: 1.2em; font-weight: bold; color: #ef4444;">${avgStrength}%</div>
                    <div style="font-size: 0.8em; color: #94a3b8;">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚ÙˆØ©</div>
                </div>
            </div>
        </div>
    `;
    
    statsBox.innerHTML = html;
};

window.showStrongResultsSection = function() {
    showTab('strongResults');
};

// ==================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ====================
window.showPlayersManagement = function() {
    if (currentUser?.role !== "admin") {
        showToast("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„", "error");
        return;
    }
    
    const allPlayers = getAllPlayers();
    
    let html = '<h4>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h4>';
    
    if (allPlayers.length === 0) {
        html += '<p style="color: #94a3b8; text-align: center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ†</p>';
    } else {
        html += '<div style="margin-bottom: 15px;">';
        html += `<p style="color: #94a3b8; text-align: center;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†: <strong>${allPlayers.length}</strong></p>`;
        html += '</div>';
        
        allPlayers.forEach(player => {
            html += `
                <div class="player-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${player}</strong>
                        </div>
                        <div class="player-actions">
                            <button onclick="renamePlayer('${player}')" class="secondary">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                            <button onclick="deletePlayer('${player}')" class="danger">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
            <div style="margin-top: 20px; padding: 15px; background: #1e293b; border-radius: 8px;">
                <h5 style="margin-top: 0; margin-bottom: 15px; color: #8b5cf6;">â• Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨ Ø¬Ø¯ÙŠØ¯</h5>
                <input type="text" id="newPlayerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯" style="margin-bottom: 10px;">
                <button onclick="addNewPlayer()" class="admin" style="width: 100%;">â• Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨</button>
            </div>
        `;
    }
    
    document.getElementById('statsBox').innerHTML = html;
    showTab('stats');
};

function getAllPlayers() {
    const allPlayersSet = new Set();
    
    // Ù…Ù† Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª
    if (window.competitions && Array.isArray(window.competitions)) {
        window.competitions.forEach(c => {
            if (c.players && Array.isArray(c.players)) {
                c.players.forEach(p => {
                    if (p.includes(" & ")) {
                        p.split(" & ").forEach(pl => {
                            const trimmed = pl.trim();
                            if (trimmed) allPlayersSet.add(trimmed);
                        });
                    } else {
                        const trimmed = p.trim();
                        if (trimmed) allPlayersSet.add(trimmed);
                    }
                });
            }
        });
    }
    
    // Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù‚ÙˆÙŠØ©
    if (window.strongResults && Array.isArray(window.strongResults)) {
        window.strongResults.forEach(sr => {
            if (sr.winner) allPlayersSet.add(sr.winner.trim());
            if (sr.loser) allPlayersSet.add(sr.loser.trim());
            if (sr.winnerPartner) allPlayersSet.add(sr.winnerPartner.trim());
            if (sr.loserPartner) allPlayersSet.add(sr.loserPartner.trim());
        });
    }
    
    // Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    USERS.forEach(user => {
        if (user.n) allPlayersSet.add(user.n.trim());
    });
    
    return Array.from(allPlayersSet).sort();
}

// ==================== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ====================
async function loadFromCloud(collection) {
    if (!window.firebaseEnabled) {
        console.log(`âš ï¸ ${collection}: Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ù…Ø¹Ø·Ù„Ø©`);
        return null;
    }
    
    if (!window.isOnline) {
        console.log(`âš ï¸ ${collection}: ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª`);
        updateSyncStatus("ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„", "offline");
        return null;
    }
    
    try {
        updateSyncStatus(`ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ${collection}...`, "syncing");
        
        const response = await fetch(
            `https://firestore.googleapis.com/v1/projects/winner-71276/databases/(default)/documents/${collection}`,
            { 
                headers: { 'Accept': 'application/json' }
            }
        );
        
        if (response.ok) {
            const data = await response.json();
            
            const items = [];
            
            if (data.documents) {
                data.documents.forEach(doc => {
                    const fields = doc.fields;
                    const item = { firebaseId: doc.name.split('/').pop() };
                    
                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
                    for (const [key, value] of Object.entries(fields)) {
                        if (value.stringValue !== undefined) {
                            item[key] = value.stringValue;
                        } else if (value.integerValue !== undefined) {
                            item[key] = parseInt(value.integerValue);
                        } else if (value.doubleValue !== undefined) {
                            item[key] = parseFloat(value.doubleValue);
                        } else if (value.booleanValue !== undefined) {
                            item[key] = value.booleanValue;
                        } else if (value.arrayValue?.values) {
                            item[key] = value.arrayValue.values.map(v => v.stringValue);
                        }
                    }
                    
                    items.push(item);
                });
            }
            
            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${items.length} Ø¹Ù†ØµØ± Ù…Ù† ${collection}`);
            
            if (collection === 'competitions') {
                return { competitions: items };
            } else if (collection === 'strongResults') {
                return { strongResults: items };
            }
            
        } else {
            console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ${collection}: ${response.status}`);
            return null;
        }
    } catch (error) {
        console.error(`âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ${collection}:`, error);
        return null;
    }
}

async function saveToCloud(collection, data) {
    if (!window.firebaseEnabled || !window.isOnline) {
        throw new Error("ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª");
    }
    
    try {
        const firestoreData = { fields: {} };
        
        for (const [key, value] of Object.entries(data)) {
            if (key === 'firebaseId') continue;
            
            if (typeof value === 'string') {
                firestoreData.fields[key] = { stringValue: value };
            } else if (typeof value === 'number') {
                if (Number.isInteger(value)) {
                    firestoreData.fields[key] = { integerValue: value.toString() };
                } else {
                    firestoreData.fields[key] = { doubleValue: value };
                }
            } else if (typeof value === 'boolean') {
                firestoreData.fields[key] = { booleanValue: value };
            } else if (Array.isArray(value)) {
                firestoreData.fields[key] = {
                    arrayValue: {
                        values: value.map(v => ({ stringValue: v }))
                    }
                };
            }
        }
        
        const response = await fetch(
            `https://firestore.googleapis.com/v1/projects/winner-71276/databases/(default)/documents/${collection}`,
            {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(firestoreData)
            }
        );
        
        if (response.ok) {
            const result = await response.json();
            return result.name.split('/').pop();
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || `ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ ${collection}`);
        }
    } catch (error) {
        console.error(`âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ ${collection}:`, error);
        throw error;
    }
}

async function deleteFromCloud(collection, firebaseId) {
    if (!window.firebaseEnabled || !window.isOnline) {
        throw new Error("ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª");
    }
    
    try {
        const response = await fetch(
            `https://firestore.googleapis.com/v1/projects/winner-71276/databases/(default)/documents/${collection}/${firebaseId}`,
            { 
                method: 'DELETE'
            }
        );
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || `ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† ${collection}`);
        }
        
        return true;
    } catch (error) {
        console.error(`âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† ${collection}:`, error);
        throw error;
    }
}

// ==================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ====================
window.showUsersManagement = function() {
    if (!currentUser || currentUser.role !== "admin") {
        showToast("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„", "error");
        return;
    }
    
    let html = '<h4 style="color: #8b5cf6; margin-top: 0;">ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h4>';
    
    html += `
        <div style="margin-bottom: 20px; padding: 15px; background: #1e293b; border-radius: 8px;">
            <h5 style="margin-top: 0; margin-bottom: 15px;">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h5>
            <div style="display: grid; gap: 10px;">
                <input type="text" id="newUserName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ù„Ø¯Ø®ÙˆÙ„)" style="margin-bottom: 5px;">
                <input type="text" id="newUserDisplayName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶" style="margin-bottom: 5px;">
                <input type="password" id="newUserPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="margin-bottom: 5px;">
                <select id="newUserRole" style="margin-bottom: 10px;">
                    <option value="user">ğŸ‘¤ Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ</option>
                    <option value="admin">ğŸ‘‘ Ù…Ø³Ø¤ÙˆÙ„</option>
                </select>
                <button onclick="addNewUser()" class="admin">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
            </div>
        </div>
    `;
    
    html += '<h5 style="margin-bottom: 15px;">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h5>';
    
    if (USERS.length === 0) {
        html += '<p style="color: #94a3b8; text-align: center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>';
    } else {
        USERS.forEach((user, index) => {
            const roleBadge = user.r === "admin" ? 
                '<span class="admin-badge" style="margin-left: 8px;">ğŸ‘‘ Ø£Ø¯Ù…Ù†</span>' : 
                '<span class="user-badge" style="margin-left: 8px;">ğŸ‘¤ Ù…Ø³ØªØ®Ø¯Ù…</span>';
            
            const isCurrentUser = currentUser.username === user.u;
            const currentUserBadge = isCurrentUser ? 
                '<span class="time-badge" style="margin-left: 8px;">ğŸ’» Ø£Ù†Øª</span>' : '';
            
            html += `
                <div class="player-card" style="border-left-color: ${user.r === 'admin' ? '#8b5cf6' : '#3b82f6'}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <strong>${user.n}</strong>
                            <div style="font-size: 0.85em; color: #94a3b8; margin-top: 5px;">
                                Ø§Ø³Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„: ${user.u}
                                ${roleBadge}
                                ${currentUserBadge}
                            </div>
                        </div>
                        <div class="player-actions">
                            ${!isCurrentUser ? `
                            <button onclick="editUser('${user.u}')" class="secondary">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                            <button onclick="deleteUser('${user.u}')" class="danger">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                            ` : `
                            <span style="color: #94a3b8; font-size: 0.9em;">Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ</span>
                            `}
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
            <div class="info-text" style="margin-top: 20px; padding: 10px; border-top: 1px solid #334155;">
                ğŸ’¡ <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${USERS.length} | Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†: ${USERS.filter(u => u.r === 'admin').length}
            </div>
        `;
    }
    
    document.getElementById('statsBox').innerHTML = html;
    showTab('stats');
};

async function addNewUser() {
    const username = document.getElementById('newUserName').value.trim();
    const displayName = document.getElementById('newUserDisplayName').value.trim();
    const password = document.getElementById('newUserPassword').value;
    const role = document.getElementById('newUserRole').value;
    
    if (!username || !displayName || !password) {
        showToast("âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„", "warning");
        return;
    }
    
    if (username.length < 3) {
        showToast("âš ï¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„", "warning");
        return;
    }
    
    if (password.length < 4) {
        showToast("âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„", "warning");
        return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (USERS.some(u => u.u === username)) {
        showToast("âš ï¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹", "warning");
        return;
    }
    
    try {
        // Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const newUser = {
            u: username,
            p: password,
            n: displayName,
            r: role,
            createdBy: currentUser.username,
            createdDate: new Date().toISOString()
        };
        
        USERS.push(newUser);
        
        // ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ù‡Ù†Ø§ Ù†Ø±Ø³Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø³Ø­Ø§Ø¨Ø©
        showToast(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${displayName}`);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        showUsersManagement();
        
        // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById('newUserName').value = '';
        document.getElementById('newUserDisplayName').value = '';
        document.getElementById('newUserPassword').value = '';
        
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", error);
        showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", "error");
    }
};

async function editUser(username) {
    const user = USERS.find(u => u.u === username);
    if (!user) return;
    
    if (currentUser.username === username) {
        showToast("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ Ù…Ù† Ù‡Ù†Ø§", "warning");
        return;
    }
    
    const newDisplayName = prompt("Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶:", user.n);
    if (!newDisplayName || newDisplayName.trim() === "") return;
    
    const newRole = confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¬Ø¹Ù„ ${newDisplayName} Ù…Ø³Ø¤ÙˆÙ„Ø§Ù‹ØŸ\n\nØ§Ø¶ØºØ· "Ù…ÙˆØ§ÙÙ‚" Ù„Ø¬Ø¹Ù„Ù‡ Ù…Ø³Ø¤ÙˆÙ„ØŒ "Ø¥Ù„ØºØ§Ø¡" Ù„Ø¬Ø¹Ù„Ù‡ Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ`) ? "admin" : "user";
    
    const newPassword = prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø§ØªØ±Ùƒ ÙØ§Ø±ØºØ§Ù‹ Ù„Ø­ÙØ¸ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©):");
    
    try {
        user.n = newDisplayName.trim();
        user.r = newRole;
        
        if (newPassword && newPassword.length >= 4) {
            user.p = newPassword;
        }
        
        showToast(`âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${user.n}`);
        showUsersManagement();
        
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", error);
        showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", "error");
    }
};

async function deleteUser(username) {
    if (currentUser.username === username) {
        showToast("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ", "warning");
        return;
    }
    
    const user = USERS.find(u => u.u === username);
    if (!user) return;
    
    showConfirmModal("Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…", `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${user.n}"ØŸ\n\nâš ï¸ Ø³ÙŠØªÙ… ÙÙ‚Ø¯Ø§Ù† Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡`, async () => {
        try {
            USERS = USERS.filter(u => u.u !== username);
            showToast(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${user.n}`);
            showUsersManagement();
        } catch (error) {
            console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", error);
            showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", "error");
        }
    });
};

// ==================== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ====================
window.showSyncStats = function() {
    if (!currentUser || currentUser.role !== "admin") {
        showToast("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„", "error");
        return;
    }
    
    const totalCompetitions = window.competitions?.length || 0;
    const totalStrongResults = window.strongResults?.length || 0;
    const totalUsers = USERS.length;
    const adminUsers = USERS.filter(u => u.r === 'admin').length;
    const totalPlayers = getAllPlayers().length;
    
    const now = new Date();
    const last24Hours = new Date(now.getTime() - (24 * 60 * 60 * 1000));
    
    const recentCompetitions = window.competitions?.filter(c => {
        const compDate = new Date(c.timestamp || c.date);
        return compDate > last24Hours;
    }).length || 0;
    
    let html = '<h4 style="color: #8b5cf6;">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h4>';
    
    html += `
        <div class="stat-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center; margin-bottom: 20px;">
                <div>
                    <div style="font-size: 1.5em; font-weight: bold; color: #22c55e;">${totalCompetitions}</div>
                    <div style="font-size: 0.9em; color: #94a3b8;">Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª</div>
                </div>
                <div>
                    <div style="font-size: 1.5em; font-weight: bold; color: #f59e0b;">${totalStrongResults}</div>
                    <div style="font-size: 0.9em; color: #94a3b8;">Ù†ØªØ§Ø¦Ø¬ Ù‚ÙˆÙŠØ©</div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center; margin-bottom: 20px;">
                <div>
                    <div style="font-size: 1.5em; font-weight: bold; color: #3b82f6;">${totalPlayers}</div>
                    <div style="font-size: 0.9em; color: #94a3b8;">Ù„Ø§Ø¹Ø¨</div>
                </div>
                <div>
                    <div style="font-size: 1.5em; font-weight: bold; color: #8b5cf6;">${totalUsers}</div>
                    <div style="font-size: 0.9em; color: #94a3b8;">Ù…Ø³ØªØ®Ø¯Ù…</div>
                </div>
            </div>
            
            <div class="stats-row">
                <span>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙˆÙ†:</span>
                <span style="color: #fbbf24; font-weight: bold;">${adminUsers}</span>
            </div>
            
            <div class="stats-row">
                <span>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙˆÙ†:</span>
                <span style="color: #3b82f6; font-weight: bold;">${totalUsers - adminUsers}</span>
            </div>
            
            <div class="stats-row">
                <span>Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª (Ø¢Ø®Ø± 24 Ø³Ø§Ø¹Ø©):</span>
                <span style="color: #22c55e; font-weight: bold;">${recentCompetitions}</span>
            </div>
            
            <div class="stats-row">
                <span>Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:</span>
                <span style="color: ${window.isOnline ? '#22c55e' : '#ef4444'}; font-weight: bold;">
                    ${window.isOnline ? 'ğŸŸ¢ Ù…ØªØµÙ„' : 'ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„'}
                </span>
            </div>
            
            <div class="stats-row">
                <span>Ø§Ù„Ø¥ØµØ¯Ø§Ø±:</span>
                <span style="color: #f59e0b; font-weight: bold;">KingBad Stats v3.5</span>
            </div>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: #1e293b; border-radius: 8px;">
            <h5 style="margin-top: 0; margin-bottom: 15px;">âš™ï¸ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h5>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="clearCache()" class="warning">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´</button>
                <button onclick="exportAllData()" class="secondary">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„ÙƒÙ„</button>
            </div>
        </div>
    `;
    
    document.getElementById('statsBox').innerHTML = html;
    showTab('stats');
};

function clearCache() {
    if (!currentUser || currentUser.role !== "admin") {
        showToast("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„", "error");
        return;
    }
    
    showConfirmModal("Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´", "Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ØŸ\n\nâš ï¸ Ù‡Ø°Ø§ Ù„Ù† ÙŠØ­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©", () => {
        window.competitions = [];
        window.strongResults = [];
        updateAppStats();
        displayCompetitionsHistory();
        displayStrongResultsHistory();
        showToast("âœ… ØªÙ… Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„ÙŠ");
    });
};

function exportAllData() {
    if (!currentUser || currentUser.role !== "admin") {
        showToast("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„", "error");
        return;
    }
    
    const exportData = {
        version: "KingBad Stats v3.5",
        exportDate: new Date().toISOString(),
        exportedBy: currentUser.username,
        users: USERS.map(u => ({
            u: u.u,
            n: u.n,
            r: u.r,
            createdBy: u.createdBy,
            createdDate: u.createdDate
        })),
        competitions: window.competitions,
        strongResults: window.strongResults,
        stats: {
            totalCompetitions: window.competitions?.length || 0,
            totalStrongResults: window.strongResults?.length || 0,
            totalPlayers: getAllPlayers().length,
            totalUsers: USERS.length
        }
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `kingbad-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast("âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
};

// ==================== Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ====================
async function resetAllData() {
    if (!currentUser || currentUser.role !== "admin") {
        showToast("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„", "error");
        return;
    }
    
    showConfirmModal(
        "ğŸ”¥ ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", 
        "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ\n\nâš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙˆÙ:\nâ€¢ ÙŠØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª\nâ€¢ ÙŠØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù‚ÙˆÙŠØ©\nâ€¢ Ù„Ø§ ÙŠØ­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!",
        async () => {
            try {
                updateSyncStatus("ğŸ”¥ Ø¬Ø§Ø±ÙŠ ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...", "syncing");
                
                // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
                if (window.competitions && Array.isArray(window.competitions)) {
                    const deletePromises = window.competitions.map(comp => 
                        comp.firebaseId ? deleteFromCloud('competitions', comp.firebaseId) : Promise.resolve()
                    );
                    await Promise.all(deletePromises);
                }
                
                // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù‚ÙˆÙŠØ© Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
                if (window.strongResults && Array.isArray(window.strongResults)) {
                    const deletePromises = window.strongResults.map(result => 
                        result.firebaseId ? deleteFromCloud('strongResults', result.firebaseId) : Promise.resolve()
                    );
                    await Promise.all(deletePromises);
                }
                
                // ØªØµÙÙŠØ± Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                window.competitions = [];
                window.strongResults = [];
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                updateAppStats();
                displayCompetitionsHistory();
                displayStrongResultsHistory();
                updatePlayersLists();
                
                updateSyncStatus("âœ… ØªÙ… Ø§Ù„ØªØµÙÙŠØ±", "online");
                showToast("âœ… ØªÙ… ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
                
            } catch (error) {
                console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
                updateSyncStatus("âŒ ÙØ´Ù„ Ø§Ù„ØªØµÙÙŠØ±", "error");
                showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
            }
        }
    );
};

// ==================== Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ====================
async function loadAllData() {
    try {
        updateSyncStatus("ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...", "syncing");
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù‚ÙˆÙŠØ©
        const compData = await loadFromCloud('competitions');
        const strongData = await loadFromCloud('strongResults');
        
        if (compData?.competitions) {
            window.competitions = compData.competitions;
            updateAppStats();
            displayCompetitionsHistory();
        }
        
        if (strongData?.strongResults) {
            window.strongResults = strongData.strongResults;
            displayStrongResultsHistory();
        }
        
        updatePlayersLists();
        updateSyncStatus("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "online");
        showToast("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
        updateSyncStatus("âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„", "error");
        showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
    }
}

async function loadCompetitions() {
    try {
        updateSyncStatus("ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª...", "syncing");
        
        const cloudData = await loadFromCloud('competitions');
        if (cloudData?.competitions) {
            window.competitions = cloudData.competitions;
            updateAppStats();
            displayCompetitionsHistory();
            updatePlayersLists();
            updateSyncStatus("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª", "online");
        }
        
    } catch (error) {
        console.error("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª:", error);
        updateSyncStatus("âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„", "error");
    }
}

// ==================== Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ====================
window.login = function() {
    const username = document.getElementById('user').value;
    const password = document.getElementById('pass').value;
    
    if (!username || !password) {
        document.getElementById('loginMsg').textContent = "âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±";
        return;
    }
    
    const user = USERS.find(u => u.u === username && u.p === password);
    
    if (user) {
        currentUser = {
            username: user.u,
            name: user.n,
            role: user.r,
            loginTime: new Date().toLocaleString('ar-SA')
        };
        
        updateUserInterface();
        document.getElementById('loginBox').style.display = "none";
        document.getElementById('appBox').style.display = "block";
        loadAllData();
        document.getElementById('loginMsg').textContent = "";
        
        window.sessionUser = currentUser;
        
    } else {
        document.getElementById('loginMsg').textContent = "âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
    }
};

window.logout = function() {
    showConfirmModal("ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬", "Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ", () => {
        currentUser = null;
        window.deleteMode = false;
        window.sessionUser = null;
        document.getElementById('appBox').style.display = "none";
        document.getElementById('loginBox').style.display = "block";
        document.getElementById('currentUserInfo').style.display = "none";
        document.getElementById('logoutBtn').style.display = "none";
        document.getElementById('adminToggleBtn').style.display = "none";
        document.getElementById('syncBtn').style.display = "none";
        document.getElementById('adminPanel').style.display = "none";
        document.getElementById('syncStatus').style.display = "none";
        document.getElementById('user').value = "";
        document.getElementById('pass').value = "";
        showToast("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­");
    });
};

function updateUserInterface() {
    if (currentUser) {
        document.getElementById('currentUserName').textContent = currentUser.name;
        document.getElementById('currentUserInfo').style.display = "block";
        document.getElementById('logoutBtn').style.display = "block";
        document.getElementById('syncBtn').style.display = "block";
        document.getElementById('syncStatus').style.display = "block";
        
        if (currentUser.role === "admin") {
            document.getElementById('currentUserRole').style.display = "inline-block";
            document.getElementById('adminToggleBtn').style.display = "block";
        }
    }
}

// ==================== Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ====================
window.onload = function() {
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    if (window.sessionUser) {
        currentUser = window.sessionUser;
        updateUserInterface();
        document.getElementById('loginBox').style.display = "none";
        document.getElementById('appBox').style.display = "block";
        loadAllData();
    }
    
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    addIndividual();
    addIndividual();
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„
    window.addEventListener('online', () => {
        window.isOnline = true;
        updateSyncStatus("ğŸŸ¢ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª", "online");
        if (currentUser) {
            loadAllData();
        }
    });
    
    window.addEventListener('offline', () => {
        window.isOnline = false;
        updateSyncStatus("ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„", "offline");
    });
    
    if (navigator.onLine) {
        updateSyncStatus("ğŸŸ¢ Ø¬Ø§Ù‡Ø²", "online");
    } else {
        updateSyncStatus("ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„", "offline");
    }
};

// ==================== Ø¯ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù…Ù‡Ø§Ù… ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© ====================
window.exportCSV = function() {
    showToast("â³ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±", "info");
};

window.renamePlayer = function(player) {
    showToast("â³ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±", "info");
};

window.deletePlayer = function(player) {
    showToast("â³ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±", "info");
};

window.addNewPlayer = function() {
    showToast("â³ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±", "info");
};

window.showTopStrongPlayers = function() {
    showToast("â³ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±", "info");
};

window.showStrongHistory = function() {
    showToast("â³ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±", "info");
};
</script>
</body>
</html>
