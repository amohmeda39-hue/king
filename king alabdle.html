<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KingBad Stats ğŸ‘‘ğŸ¤¡</title>
<style>
*,:after,:before{box-sizing:border-box;margin:0;padding:0}body{font-family:Tahoma,sans-serif;background:#020617;color:#fff;padding:20px;direction:rtl;margin:0;overflow-x:hidden}.card{background:#0f172a;padding:15px;border-radius:10px;border:1px solid #1e293b;max-width:600px;margin:20px auto;box-shadow:0 4px 6px rgba(0,0,0,.3)}h1,h2,h3,h4{color:#e2e8f0;margin-top:0}h1{text-align:center;color:#fbbf24;margin-bottom:20px}input,select,button{width:100%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #334155;font-size:14px;box-sizing:border-box}input,select{background:#1e293b;color:#e2e8f0}button{background:#22c55e;color:#fff;font-weight:bold;cursor:pointer;border:none;transition:background .3s}button:hover{background:#16a34a}button.secondary{background:#3b82f6}button.secondary:hover{background:#2563eb}button.danger{background:#ef4444}button.danger:hover{background:#dc2626}button.admin{background:#8b5cf6}button.admin:hover{background:#7c3aed}.app{display:none}#loginMsg{text-align:center;margin-top:10px;color:#ef4444;font-size:14px}#individualBox,#teamBox{margin-top:15px}#individuals input,#teams input{margin:5px 0}#teams div{display:flex;gap:10px;margin:5px 0}#teams div input{flex:1}.stats-buttons{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}.stats-buttons button{flex:1;min-width:80px}#statsBox,#compareResult,#competitionsHistory{margin-top:15px;padding:15px;background:#1e293b;border-radius:8px;min-height:50px}.competition-item{background:#1e293b;margin:10px 0;padding:12px;border-radius:8px;border-right:4px solid #22c55e;transition:all .3s;position:relative}.competition-item:hover{background:#334155;transform:translateX(-5px)}.user-badge{display:inline-block;background:#3b82f6;color:#fff;padding:2px 10px;border-radius:12px;font-size:.85em;margin:0 5px}.time-badge{display:inline-block;background:#10b981;color:#fff;padding:2px 10px;border-radius:12px;font-size:.85em;margin:0 5px}.admin-badge{display:inline-block;background:#8b5cf6;color:#fff;padding:2px 10px;border-radius:12px;font-size:.85em;margin:0 5px}.info-text{color:#94a3b8;font-size:.9em;margin-top:5px}.current-user{position:fixed;top:20px;left:20px;background:#1e293b;padding:8px 15px;border-radius:20px;font-size:.9em;border:1px solid #334155;z-index:1000}.logout-btn{position:fixed;top:20px;right:20px;background:#ef4444;color:#fff;padding:8px 15px;border-radius:20px;border:none;cursor:pointer;font-size:.9em;z-index:1000}.logout-btn:hover{background:#dc2626}.admin-panel{position:fixed;top:60px;right:20px;background:#1e293b;padding:15px;border-radius:10px;border:2px solid #8b5cf6;z-index:1000;width:300px;display:none}.delete-btn{position:absolute;top:5px;left:5px;background:#ef4444;color:#fff;border:none;border-radius:50%;width:25px;height:25px;cursor:pointer;font-size:12px;display:none}.delete-btn:hover{background:#dc2626}.admin-visible .delete-btn{display:block}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:2000;align-items:center;justify-content:center}.modal-content{background:#0f172a;padding:20px;border-radius:10px;max-width:500px;width:90%;border:2px solid #8b5cf6}.modal-buttons{display:flex;gap:10px;margin-top:20px}.player-management{display:grid;grid-template-columns:1fr 1fr;gap:10px}.toggle-btns{position:fixed;top:60px;right:20px;z-index:1000;display:flex;gap:5px}.sync-status{position:fixed;bottom:20px;right:20px;background:#1e293b;padding:8px 15px;border-radius:20px;font-size:.9em;border:1px solid #334155;z-index:1000}.online{color:#22c55e}.offline{color:#ef4444}.syncing{color:#fbbf24}.saving{color:#fbbf24}.loading{color:#3b82f6}.error{color:#ef4444}.toast{position:fixed;bottom:80px;right:20px;background:#0f172a;padding:12px 20px;border-radius:8px;border-left:4px solid #22c55e;box-shadow:0 4px 12px rgba(0,0,0,.4);z-index:2000;max-width:400px;display:none}.toast.error{border-left-color:#ef4444}.toast.warning{border-left-color:#fbbf24}.toast.info{border-left-color:#3b82f6}@media (max-width:768px){body{padding:10px}.card{max-width:100%;margin:10px 0;padding:12px}.current-user,.logout-btn,.admin-panel,.toggle-btns,.sync-status{position:static;margin:10px;display:block;width:auto}#teams div{flex-direction:column;gap:5px}.stats-buttons{flex-direction:column}.player-management{grid-template-columns:1fr}.toast{right:10px;left:10px;bottom:100px}}
</style>
</head>
<body>

<!-- Toast Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
<div id="toast" class="toast"></div>

<!-- Ù†ÙˆØ§ÙØ° Ø§Ù„ØªØ£ÙƒÙŠØ¯ -->
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</h3>
        <p id="modalMessage">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ</p>
        <div class="modal-buttons">
            <button onclick="confirmAction(true)" class="danger">Ù†Ø¹Ù…</button>
            <button onclick="confirmAction(false)">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
<div id="currentUserInfo" class="current-user" style="display: none;">
    <span id="currentUserName"></span>
    <span id="currentUserRole" class="admin-badge" style="display: none;">Ø£Ø¯Ù…Ù†</span>
</div>

<!-- Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© -->
<div id="syncStatus" class="sync-status" style="display: none;">
    <span id="syncStatusText">ğŸ”µ Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
</div>

<!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
<div class="toggle-btns">
    <button id="adminToggleBtn" class="admin" onclick="toggleAdminPanel()" style="display: none;">âš™ï¸ Ø£Ø¯Ù…Ù†</button>
    <button id="syncBtn" class="secondary" onclick="syncData()" style="display: none;">ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø©</button>
</div>

<!-- Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† -->
<div id="adminPanel" class="admin-panel">
    <h3 style="color: #8b5cf6; margin-top: 0;">ğŸ‘‘ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†</h3>
    <div style="display: grid; gap: 10px;">
        <button onclick="toggleDeleteMode()" class="admin">ğŸ—‘ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø°Ù</button>
        <button onclick="exportData()" class="admin">ğŸ“¥ ØªØµØ¯ÙŠØ± JSON</button>
        <button onclick="exportCSV()" class="admin">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
        <button onclick="importData()" class="admin">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button onclick="showPlayersManagement()" class="admin">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</button>
        <button onclick="showUsersManagement()" class="admin">ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
        <button onclick="resetAllData()" class="danger">ğŸ”¥ ØªØµÙÙŠØ± Ø§Ù„ÙƒÙ„</button>
        <button onclick="showBackupRestore()" class="secondary">ğŸ’¾ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
        <button onclick="forceSync()" class="secondary">âš¡ Ù…Ø²Ø§Ù…Ù†Ø© Ù‚Ø³Ø±ÙŠØ©</button>
        <button onclick="showSyncStats()" class="secondary">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</button>
    </div>
</div>

<button id="logoutBtn" class="logout-btn" onclick="logout()" style="display: none;">ğŸšª Ø®Ø±ÙˆØ¬</button>

<!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div class="card" id="loginBox">
    <h2>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <div style="text-align: center; margin-bottom: 15px;">
        <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #22c55e, #3b82f6); border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 30px;">
            ğŸ‘‘
        </div>
    </div>
    <input id="user" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" autocomplete="off">
    <input id="pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="off">
    <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
    <div id="loginMsg"></div>
    <div class="info-text" style="text-align: center; margin-top: 15px;">
        KingBad Stats v2.5 ğŸ‘‘ğŸ¤¡<br>
        Ù†Ø¸Ø§Ù… Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù… Ù…Ø¹ ØªØ®Ø²ÙŠÙ† Ø³Ø­Ø§Ø¨ÙŠ
    </div>
</div>

<!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<div class="app" id="appBox">
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1 style="margin: 0;">ğŸ‘‘ğŸ¤¡ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙƒÙ†Ø¬ ÙˆØ§Ù„Ø¨Ø¹Ø±ÙˆØ±</h1>
        <div id="appStats" style="font-size: 0.9em; color: #94a3b8;">
            <span id="totalCompetitions">0</span> Ø¯ÙˆØ±ÙŠ | <span id="totalPlayers">0</span> Ù„Ø§Ø¹Ø¨
        </div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ù„Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ -->
    <datalist id="playersDatalist"></datalist>

    <!-- Ù‚Ø³Ù… Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±ÙŠ -->
    <div class="card">
        <h3>â• Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±ÙŠ Ø¬Ø¯ÙŠØ¯</h3>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <select id="type" onchange="switchMode()" style="flex: 1;">
                <option value="individual">ğŸ® ÙØ±Ø¯ÙŠ</option>
                <option value="team">ğŸ‘¥ Ø«Ù†Ø§Ø¦ÙŠ</option>
            </select>
            <button onclick="quickAddPlayers()" class="secondary" style="width: auto;">âš¡ Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø©</button>
        </div>

        <div id="individualBox">
            <div id="individuals"></div>
            <button onclick="addIndividual()">â• Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨</button>
        </div>

        <div id="teamBox" style="display:none">
            <div id="teams"></div>
            <button onclick="addTeam()">â• Ø¥Ø¶Ø§ÙØ© ÙØ±ÙŠÙ‚</button>
        </div>

        <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button id="saveButton" onclick="saveCompetition()" style="flex: 3;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±ÙŠ</button>
            <button onclick="clearForm()" class="secondary" style="flex: 1;">ğŸ—‘ï¸ Ù…Ø³Ø­</button>
        </div>
        <div class="info-text">
            ğŸ“… Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ù„ÙŠØ§Ù‹ ÙˆÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        </div>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div class="card">
        <h3>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
        <div class="stats-buttons">
            <button onclick="toggleStats('individual')">ğŸ® ÙØ±Ø¯ÙŠ</button>
            <button onclick="toggleStats('team')">ğŸ‘¥ Ø«Ù†Ø§Ø¦ÙŠ</button>
            <button onclick="toggleStats('all')">ğŸ“ˆ Ø¹Ø§Ù…</button>
            <button onclick="showMyStats()" class="secondary">ğŸ‘¤ Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙŠ</button>
            <button onclick="showTopPlayers()" class="secondary">ğŸ† Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</button>
            <button onclick="showHistory()" class="secondary">ğŸ“œ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙƒØ§Ù…Ù„</button>
        </div>
        <div id="statsBox">
            <p style="text-align: center; color: #94a3b8;">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</p>
        </div>
    </div>

    <!-- Ù‚Ø³Ù… Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† -->
    <div class="card">
        <h3>ğŸ†š Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h3>
        <div class="player-management">
            <select id="playerA">
                <option value="">ğŸ‘¤ Ø§Ø®ØªØ± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„</option>
            </select>
            <select id="playerB">
                <option value="">ğŸ‘¤ Ø§Ø®ØªØ± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
            </select>
        </div>
        <select id="compareElement">
            <option value="total">ğŸ® Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª</option>
            <option value="king">ğŸ‘‘ Ø§Ù„ÙƒÙ†Ø¬</option>
            <option value="bad">ğŸ¤¡ Ø§Ù„Ø¨Ø¹Ø±ÙˆØ±</option>
            <option value="winRate">ğŸ“Š Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ²</option>
        </select>
        <button onclick="toggleCompare()">Ù…Ù‚Ø§Ø±Ù†Ø©</button>
        <div id="compareResult"></div>
    </div>

    <!-- Ù‚Ø³Ù… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª -->
    <div class="card">
        <h3>ğŸ“‹ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ©</h3>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div class="info-text">Ø¢Ø®Ø± 15 Ø¯ÙˆØ±ÙŠØ© Ù…Ø¶Ø§ÙØ©</div>
            <button onclick="refreshData()" class="secondary" style="width: auto;">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
        </div>
        <div id="competitionsHistory">
            <p style="text-align: center; color: #94a3b8;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª...</p>
        </div>
    </div>

    <!-- ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø© -->
    <div style="text-align: center; margin-top: 30px; color: #64748b; font-size: 0.9em;">
        <hr style="border-color: #334155; margin: 20px 0;">
        <div>KingBad Stats v2.5 ğŸ‘‘ğŸ¤¡ | ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø¹Ø¨Ø¯Ù„ÙŠ</div>
        <div style="margin-top: 5px;">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2024 | ØªØ®Ø²ÙŠÙ† Ø³Ø­Ø§Ø¨ÙŠ Ù…ØªÙƒØ§Ù…Ù„</div>
    </div>
</div>

<script>
// ==================== Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ====================
const encrypt = (text) => btoa(encodeURIComponent(text));
const decrypt = (text) => decodeURIComponent(atob(text));

window.encryptedStorage = {
    set: (key, value) => localStorage.setItem(encrypt(key), encrypt(JSON.stringify(value))),
    get: (key) => {
        const item = localStorage.getItem(encrypt(key));
        return item ? JSON.parse(decrypt(item)) : null;
    },
    remove: (key) => localStorage.removeItem(encrypt(key)),
    clear: () => localStorage.clear()
};

// ==================== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ====================
let USERS = [
    {u:"player1",p:"1234",n:"Ø§Ù„Ù„Ø§Ø¹Ø¨ 1",r:"user",c:0},
    {u:"player2",p:"1234",n:"Ø§Ù„Ù„Ø§Ø¹Ø¨ 2",r:"user",c:0},
    {u:"player3",p:"1234",n:"Ø§Ù„Ù„Ø§Ø¹Ø¨ 3",r:"user",c:0},
    {u:"alabdle",p:"admin123",n:"Ø§Ù„Ø¹Ø¨Ø¯Ù„ÙŠ",r:"admin",c:0}
];

window.competitions = [];
window.allPlayers = new Set();
window.currentUser = null;
window.deleteMode = false;
window.pendingAction = null;
window.isOnline = navigator.onLine;
window.firebaseEnabled = true;
window.pendingSync = [];
window.isSaving = false;
window.lastSyncTime = null;

// ==================== Ø¯Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ====================
function showToast(message, type = 'info', duration = 3000) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast ${type}`;
    toast.style.display = 'block';
    
    setTimeout(() => {
        toast.style.display = 'none';
    }, duration);
}

function updateSaveButtonState(isSaving) {
    const saveButton = document.getElementById('saveButton');
    if (isSaving) {
        saveButton.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
        saveButton.disabled = true;
        saveButton.style.opacity = '0.7';
        saveButton.style.cursor = 'not-allowed';
    } else {
        saveButton.innerHTML = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±ÙŠ';
        saveButton.disabled = false;
        saveButton.style.opacity = '1';
        saveButton.style.cursor = 'pointer';
    }
}

function updateSyncStatus(text, status) {
    const statusElement = document.getElementById('syncStatus');
    const textElement = document.getElementById('syncStatusText');
    
    if (statusElement && textElement) {
        statusElement.style.display = 'block';
        textElement.textContent = text;
        textElement.className = status;
        window.isOnline = status === "online" || status === "syncing";
    }
}

// ==================== Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…ØµØ­Ø­Ø© ====================
window.deleteCompetition = function(id) {
    if (!currentUser || currentUser.role !== "admin") {
        showToast("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø­Ø°Ù", "error");
        return;
    }
    
    showConfirmModal("ğŸ—‘ï¸ Ø­Ø°Ù Ø¯ÙˆØ±ÙŠ", 
        "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ±ÙŠØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.", 
        async () => {
            try {
                // 1. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø°ÙÙ‡
                const competitionIndex = window.competitions.findIndex(c => c.id === id);
                
                if (competitionIndex === -1) {
                    showToast("âŒ Ø§Ù„Ø¯ÙˆØ±ÙŠ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯", "error");
                    return;
                }
                
                const competition = window.competitions[competitionIndex];
                
                // 2. Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                window.competitions.splice(competitionIndex, 1);
                encryptedStorage.set('competitions', window.competitions);
                
                // 3. Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØµÙ„Ø§Ù‹
                if (window.firebaseEnabled && window.isOnline) {
                    try {
                        // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ù„Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù€ firebaseId
                        const response = await fetch(
                            "https://firestore.googleapis.com/v1/projects/winner-71276/databases/(default)/documents/competitions",
                            { headers: { 'Accept': 'application/json' } }
                        );
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.documents) {
                                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø°ÙŠ ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ù…Ø­Ù„ÙŠ
                                const matchingDoc = data.documents.find(doc => {
                                    const docFields = doc.fields;
                                    const docPlayers = docFields.players?.arrayValue?.values?.map(v => v.stringValue) || [];
                                    const docAddedBy = docFields.addedBy?.stringValue || "";
                                    const docTimestamp = docFields.timestamp?.stringValue || "";
                                    
                                    // Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                                    return docPlayers.length === competition.players.length &&
                                           docPlayers.every(player => competition.players.includes(player)) &&
                                           docAddedBy === competition.addedBy &&
                                           docTimestamp === competition.timestamp;
                                });
                                
                                if (matchingDoc) {
                                    // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
                                    await fetch(
                                        `https://firestore.googleapis.com/v1/${matchingDoc.name}`,
                                        { method: 'DELETE' }
                                    );
                                    console.log(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±ÙŠ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©: ${competition.id}`);
                                }
                            }
                        }
                    } catch (cloudError) {
                        console.log("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±ÙŠ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©:", cloudError.message);
                    }
                }
                
                // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                updateAppStats();
                displayCompetitionsHistory();
                updatePlayersLists();
                
                showToast("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø¨Ù†Ø¬Ø§Ø­");
                
            } catch (error) {
                console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±ÙŠ:", error);
                showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±ÙŠ", "error");
            }
        }
    );
};

// ==================== Ø¯Ø§Ù„Ø© ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø³Ù†Ø© ====================
window.toggleDeleteMode = function() {
    if (!currentUser || currentUser.role !== "admin") {
        showToast("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„", "error");
        return;
    }
    
    deleteMode = !deleteMode;
    
    // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø°Ù
    const items = document.querySelectorAll('.competition-item');
    items.forEach(item => {
        if (deleteMode) {
            item.classList.add('admin-visible');
        } else {
            item.classList.remove('admin-visible');
        }
    });
    
    showToast(deleteMode ? "âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø°Ù" : "âŒ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø°Ù");
};

// ==================== Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ ====================
async function loadFromCloud() {
    if (!window.firebaseEnabled || !window.isOnline) {
        console.log("âš ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø·");
        return null;
    }
    
    try {
        updateSyncStatus("ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...", "syncing");
        
        const response = await fetch(
            "https://firestore.googleapis.com/v1/projects/winner-71276/databases/(default)/documents/competitions",
            { 
                headers: { 'Accept': 'application/json' },
                signal: AbortSignal.timeout(10000)
            }
        );
        
        if (response.ok) {
            const data = await response.json();
            const cloudCompetitions = [];
            
            if (data.documents) {
                data.documents.forEach(doc => {
                    const fields = doc.fields;
                    cloudCompetitions.push({
                        id: doc.name.split('/').pop(),
                        firebaseId: doc.name.split('/').pop(),
                        players: fields.players?.arrayValue?.values?.map(v => v.stringValue) || [],
                        addedBy: fields.addedBy?.stringValue || "Ù…Ø¬Ù‡ÙˆÙ„",
                        addedByName: fields.addedByName?.stringValue || "Ù…Ø¬Ù‡ÙˆÙ„",
                        timestamp: fields.timestamp?.stringValue || new Date().toISOString(),
                        date: fields.date?.stringValue || new Date().toLocaleDateString('ar-SA'),
                        time: fields.time?.stringValue || new Date().toLocaleTimeString('ar-SA'),
                        dateTime: fields.dateTime?.stringValue || new Date().toLocaleString('ar-SA')
                    });
                });
            }
            
            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${cloudCompetitions.length} Ø¯ÙˆØ±ÙŠ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©`);
            updateSyncStatus("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©", "online");
            return { competitions: cloudCompetitions };
            
        } else {
            throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©');
        }
    } catch (error) {
        console.error("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©:", error);
        showToast("âš ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø·", "warning");
        updateSyncStatus("ğŸ”´ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©", "offline");
        return null;
    }
}

async function syncToCloud(competitionData) {
    if (!window.firebaseEnabled || !window.isOnline) {
        console.log("âš ï¸ Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ ÙÙ‚Ø· (ØºÙŠØ± Ù…ØªØµÙ„)");
        window.pendingSync.push(competitionData);
        encryptedStorage.set('pendingSync', window.pendingSync);
        return false;
    }
    
    try {
        const firestoreData = {
            fields: {
                players: {
                    arrayValue: {
                        values: competitionData.players.map(player => ({ stringValue: player }))
                    }
                },
                addedBy: { stringValue: competitionData.addedBy },
                addedByName: { stringValue: competitionData.addedByName },
                timestamp: { stringValue: competitionData.timestamp },
                date: { stringValue: competitionData.date },
                time: { stringValue: competitionData.time },
                dateTime: { stringValue: competitionData.dateTime }
            }
        };
        
        const response = await fetch(
            "https://firestore.googleapis.com/v1/projects/winner-71276/databases/(default)/documents/competitions",
            {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(firestoreData),
                signal: AbortSignal.timeout(8000)
            }
        );
        
        if (response.ok) {
            const data = await response.json();
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù€ firebaseId Ù„Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ù…Ø­Ù„ÙŠ
            competitionData.firebaseId = data.name.split('/').pop();
            console.log("âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©");
            return true;
        } else {
            throw new Error('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©');
        }
    } catch (error) {
        console.error("âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø³Ø­Ø§Ø¨Ø©:", error);
        showToast("âš ï¸ ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙˆØ³ÙŠØªÙ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹", "warning");
        window.pendingSync.push(competitionData);
        encryptedStorage.set('pendingSync', window.pendingSync);
        return false;
    }
}

// ==================== Ø¯Ø§Ù„Ø© Ø°ÙƒÙŠØ© Ù„Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ====================
function smartMergeData(cloudData) {
    const localCompetitions = window.competitions;
    const mergedCompetitions = [...localCompetitions];
    let newCompetitionsCount = 0;
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø±ÙŠØ·Ø© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    const localDataMap = new Map();
    localCompetitions.forEach(comp => {
        const uniqueKey = createCompetitionKey(comp);
        localDataMap.set(uniqueKey, comp);
    });
    
    // ÙØ­Øµ ÙƒÙ„ Ø¯ÙˆØ±ÙŠ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
    cloudData.forEach(cloudComp => {
        const uniqueKey = createCompetitionKey(cloudComp);
        
        if (!localDataMap.has(uniqueKey)) {
            mergedCompetitions.push(cloudComp);
            newCompetitionsCount++;
            console.log(`â• Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±ÙŠ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©: ${cloudComp.players.join('ØŒ ')}`);
        }
    });
    
    // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
    mergedCompetitions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    window.competitions = mergedCompetitions;
    encryptedStorage.set('competitions', window.competitions);
    
    if (newCompetitionsCount > 0) {
        showToast(`âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${newCompetitionsCount} Ø¯ÙˆØ±ÙŠ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©`);
    }
    
    window.lastSyncTime = new Date();
    return newCompetitionsCount;
}

function createCompetitionKey(competition) {
    const sortedPlayers = competition.players.slice().sort();
    const datePart = competition.date || '';
    const timePart = competition.time || '';
    return sortedPlayers.join('|') + '|' + datePart + '|' + timePart + '|' + competition.addedBy;
}

// ==================== Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ====================
window.login = function() {
    const username = document.getElementById('user').value;
    const password = document.getElementById('pass').value;
    
    if (!username || !password) {
        document.getElementById('loginMsg').textContent = "âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±";
        return;
    }
    
    const user = USERS.find(u => u.u === username && u.p === password);
    
    if (user) {
        currentUser = {
            username: user.u,
            name: user.n,
            role: user.r,
            loginTime: new Date().toLocaleString('ar-SA')
        };
        
        encryptedStorage.set('currentUser', currentUser);
        updateUserInterface();
        document.getElementById('loginBox').style.display = "none";
        document.getElementById('appBox').style.display = "block";
        loadCompetitions();
        document.getElementById('loginMsg').textContent = "";
        
    } else {
        document.getElementById('loginMsg').textContent = "âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
    }
};

window.logout = function() {
    showConfirmModal("ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬", "Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ", () => {
        currentUser = null;
        deleteMode = false;
        encryptedStorage.remove('currentUser');
        document.getElementById('appBox').style.display = "none";
        document.getElementById('loginBox').style.display = "block";
        document.getElementById('currentUserInfo').style.display = "none";
        document.getElementById('logoutBtn').style.display = "none";
        document.getElementById('adminToggleBtn').style.display = "none";
        document.getElementById('syncBtn').style.display = "none";
        document.getElementById('adminPanel').style.display = "none";
        document.getElementById('syncStatus').style.display = "none";
        document.getElementById('user').value = "";
        document.getElementById('pass').value = "";
        showToast("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­");
    });
};

function updateUserInterface() {
    if (currentUser) {
        document.getElementById('currentUserName').textContent = currentUser.name;
        document.getElementById('currentUserInfo').style.display = "block";
        document.getElementById('logoutBtn').style.display = "block";
        document.getElementById('syncBtn').style.display = "block";
        document.getElementById('syncStatus').style.display = "block";
        
        if (currentUser.role === "admin") {
            document.getElementById('currentUserRole').style.display = "inline-block";
            document.getElementById('adminToggleBtn').style.display = "block";
        }
    }
}

// ==================== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ====================
async function loadCompetitions() {
    try {
        updateSyncStatus("ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...", "syncing");
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
        let localData = encryptedStorage.get('competitions') || [];
        window.competitions = localData;
        window.pendingSync = encryptedStorage.get('pendingSync') || [];
        
        // ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†)
        setTimeout(async () => {
            try {
                const cloudData = await loadFromCloud();
                if (cloudData?.competitions?.length > 0) {
                    const newCount = smartMergeData(cloudData.competitions);
                    if (newCount > 0) {
                        updateAppStats();
                        displayCompetitionsHistory();
                        updatePlayersLists();
                    }
                }
            } catch (cloudError) {
                console.log("âš ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø·");
            }
        }, 500);
        
        updateAppStats();
        displayCompetitionsHistory();
        updatePlayersLists();
        
        if (window.pendingSync.length > 0 && window.isOnline) {
            setTimeout(() => syncPendingData(), 1000);
        }
        
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
        window.competitions = encryptedStorage.get('competitions') || [];
        updateAppStats();
        displayCompetitionsHistory();
        updatePlayersLists();
        updateSyncStatus("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„", "error");
        showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
    }
}

// ==================== Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø© ====================
window.saveCompetition = async function() {
    // Ù…Ù†Ø¹ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
    if (window.isSaving) {
        showToast("â³ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...", "warning");
        return;
    }
    
    let players = [];
    
    if (document.getElementById('type').value === "individual") {
        document.querySelectorAll("#individuals input").forEach(i => {
            const name = i.value.trim();
            if (name) players.push(name);
        });
    } else {
        document.querySelectorAll("#teams div").forEach(r => {
            const a = r.children[0].value.trim();
            const b = r.children[1].value.trim();
            if (a && b) players.push(`${a} & ${b}`);
        });
    }
    
    if (players.length < 2) {
        showToast("âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„", "warning");
        return;
    }
    
    if (!currentUser) {
        showToast("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹", "error");
        return;
    }
    
    const now = new Date();
    const competitionData = {
        id: Date.now().toString(),
        players: players,
        addedBy: currentUser.username,
        addedByName: currentUser.name,
        timestamp: now.toISOString(),
        date: now.toLocaleDateString('ar-SA'),
        time: now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }),
        dateTime: now.toLocaleString('ar-SA')
    };
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø­Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
    const competitionKey = createCompetitionKey(competitionData);
    const isDuplicate = window.competitions.some(comp => 
        createCompetitionKey(comp) === competitionKey
    );
    
    if (isDuplicate) {
        showToast("âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ±ÙŠ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„!", "warning");
        return;
    }
    
    try {
        // ØªÙØ¹ÙŠÙ„ Ù‚ÙÙ„ Ù…Ù†Ø¹ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
        window.isSaving = true;
        updateSaveButtonState(true);
        
        // 1. Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹
        window.competitions.unshift(competitionData);
        encryptedStorage.set('competitions', window.competitions);
        
        // 2. Ù…Ø­Ø§ÙˆÙ„Ø© Ø±ÙØ¹ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†)
        setTimeout(async () => {
            try {
                await syncToCloud(competitionData);
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©:", error);
            }
        }, 0);
        
        showToast(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø¨Ù†Ø¬Ø§Ø­\nğŸ‘¤ ${currentUser.name}`, "info", 2000);
        clearForm();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
        updateAppStats();
        displayCompetitionsHistory();
        updatePlayersLists();
        
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±ÙŠ:", error);
        showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±ÙŠ", "error");
    } finally {
        // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚ÙÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
        window.isSaving = false;
        updateSaveButtonState(false);
    }
};

// ==================== Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ====================
async function syncPendingData() {
    if (window.pendingSync.length === 0 || !window.isOnline) return;
    
    updateSyncStatus("ğŸ”„ Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©...", "syncing");
    let syncedCount = 0;
    
    for (let i = 0; i < window.pendingSync.length; i++) {
        const data = window.pendingSync[i];
        try {
            const success = await syncToCloud(data);
            if (success) {
                window.pendingSync.splice(i, 1);
                i--;
                syncedCount++;
                encryptedStorage.set('pendingSync', window.pendingSync);
            }
        } catch (error) {
            console.error(`âŒ ÙØ´Ù„ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¯ÙˆØ±ÙŠ: ${data.players.join('ØŒ ')}`, error);
        }
    }
    
    if (syncedCount > 0) {
        showToast(`âœ… ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© ${syncedCount} Ø¯ÙˆØ±ÙŠ Ù…Ø¹Ù„Ù‚`);
        updateSyncStatus("âœ… ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©", "online");
    }
}

// ==================== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ====================
function updateAppStats() {
    document.getElementById('totalCompetitions').textContent = window.competitions.length;
    document.getElementById('totalPlayers').textContent = window.allPlayers.size;
}

// ==================== Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø³Ù†Ø© ====================
function displayCompetitionsHistory() {
    let html = '';
    const recent = window.competitions.slice(0, 15);
    
    if (recent.length === 0) {
        html = '<p style="text-align: center; color: #94a3b8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙˆØ±ÙŠØ§Øª</p>';
    } else {
        recent.forEach(c => {
            // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø­Ø°Ù ÙÙ‚Ø· Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø¯Ù…Ù† ÙˆØ¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø°Ù
            const deleteBtn = (currentUser?.role === "admin") ? 
                `<button class="delete-btn" onclick="deleteCompetition('${c.id}')" title="Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±ÙŠ">Ã—</button>` : '';
            
            html += `
                <div class="competition-item ${(currentUser?.role === "admin" && deleteMode) ? "admin-visible" : ""}">
                    ${deleteBtn}
                    <div style="margin-bottom: 8px;">
                        <strong>ğŸ‘¥ ${c.players.join('ØŒ ')}</strong>
                    </div>
                    <div style="font-size: 0.9em;">
                        <span class="user-badge">ğŸ‘¤ ${c.addedByName}</span>
                        <span class="time-badge">ğŸ“… ${c.date}</span>
                        <span class="time-badge">â° ${c.time}</span>
                    </div>
                </div>
            `;
        });
    }
    
    document.getElementById('competitionsHistory').innerHTML = html;
}

// ==================== Ø¨Ù‚ÙŠØ© Ø§Ù„ÙˆØ¸Ø§Ø¦Ù ====================
window.toggleAdminPanel = function() {
    const panel = document.getElementById('adminPanel');
    panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
};

window.exportData = function() {
    if (currentUser?.role !== "admin") return;
    
    const data = {
        competitions: window.competitions,
        users: USERS,
        exportedAt: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `kingbad_backup_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast(`âœ… ØªÙ… ØªØµØ¯ÙŠØ± ${window.competitions.length} Ø¯ÙˆØ±ÙŠ`);
};

window.exportCSV = function() {
    if (currentUser?.role !== "admin") return;
    
    let csv = "ØªØ§Ø±ÙŠØ®,ÙˆÙ‚Øª,Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†,Ø£Ø¶ÙŠÙ Ø¨ÙˆØ§Ø³Ø·Ø©\n";
    window.competitions.forEach(c => {
        csv += `"${c.date}","${c.time}","${c.players.join(', ')}","${c.addedByName}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `kingbad_data_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast("âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ…Ù„Ù Excel");
};

window.importData = function() {
    if (currentUser?.role !== "admin") return;
    
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json,.csv';
    
    input.onchange = async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        showConfirmModal("Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª", "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„ÙØŸ", async () => {
            try {
                const text = await file.text();
                let importedData;
                
                if (file.name.endsWith('.json')) {
                    importedData = JSON.parse(text);
                } else {
                    importedData = parseCSV(text);
                }
                
                if (importedData.competitions) {
                    window.competitions = importedData.competitions;
                    encryptedStorage.set('competitions', window.competitions);
                    loadCompetitions();
                    showToast(`âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${importedData.competitions.length} Ø¯ÙˆØ±ÙŠ`);
                }
                
            } catch (error) {
                showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: " + error.message, "error");
            }
        });
    };
    
    input.click();
};

function parseCSV(csv) {
    const lines = csv.split('\n');
    const competitions = [];
    
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        const parts = line.split(',').map(part => part.replace(/^"|"$/g, '').trim());
        if (parts.length >= 4) {
            competitions.push({
                id: Date.now() + i,
                players: parts[2].split(',').map(p => p.trim()),
                addedByName: parts[3],
                addedBy: parts[3] === 'Ø§Ù„Ø¹Ø¨Ø¯Ù„ÙŠ' ? 'alabdle' : 'user',
                date: parts[0],
                time: parts[1],
                timestamp: new Date().toISOString()
            });
        }
    }
    
    return { competitions };
}

// ==================== Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ====================
window.buildStats = function(filter) {
    let stats = {};
    
    window.competitions.forEach(c => {
        const type = c.players.every(p => !p.includes(" & ")) ? "individual" : "team";
        if (filter !== "all" && filter !== type) return;
        
        const first = c.players[0];
        const last = c.players[c.players.length - 1];
        
        const firstPlayers = first.includes(" & ") ? first.split(" & ") : [first];
        const lastPlayers = last.includes(" & ") ? last.split(" & ") : [last];
        
        c.players.forEach(player => {
            const players = player.includes(" & ") ? player.split(" & ") : [player];
            players.forEach(p => {
                p = p.trim();
                if (!stats[p]) stats[p] = {total:0,king:0,bad:0};
                stats[p].total++;
            });
        });
        
        firstPlayers.forEach(p => { 
            p = p.trim();
            if(stats[p]) stats[p].king++; 
        });
        
        lastPlayers.forEach(p => { 
            p = p.trim();
            if(stats[p]) stats[p].bad++; 
        });
    });
    
    return stats;
};

window.toggleStats = function(type) {
    const stats = window.buildStats(type);
    const statsBox = document.getElementById('statsBox');
    
    let title = type === 'individual' ? "ğŸ® Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙØ±Ø¯ÙŠØ©" : 
                type === 'team' ? "ğŸ‘¥ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙØ±Ù‚" : "ğŸ“ˆ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©";
    
    let html = `<h4>${title}</h4>`;
    
    if (Object.keys(stats).length === 0) {
        html += '<p style="color: #94a3b8; text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
    } else {
        const sorted = Object.entries(stats).sort((a,b) => b[1].total - a[1].total);
        
        sorted.forEach(([player, data]) => {
            const winRate = data.total > 0 ? ((data.king / data.total) * 100).toFixed(1) : 0;
            const lossRate = data.total > 0 ? ((data.bad / data.total) * 100).toFixed(1) : 0;
            
            html += `
                <div class="competition-item">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${player}</strong>
                            <div style="font-size: 0.85em; color: #94a3b8; margin-top: 5px;">
                                <span class="user-badge">ğŸ® ${data.total}</span>
                            </div>
                        </div>
                        <div style="text-align: left;">
                            <div>ğŸ‘‘ ${data.king} (${winRate}%)</div>
                            <div>ğŸ¤¡ ${data.bad} (${lossRate}%)</div>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    statsBox.innerHTML = html;
};

window.showTopPlayers = function() {
    const stats = window.buildStats('all');
    const sorted = Object.entries(stats).sort((a,b) => b[1].king - a[1].king).slice(0, 10);
    
    let html = '<h4>ğŸ† Ø£ÙØ¶Ù„ 10 Ù„Ø§Ø¹Ø¨ÙŠÙ†</h4>';
    
    if (sorted.length === 0) {
        html += '<p style="color: #94a3b8; text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
    } else {
        sorted.forEach(([player, data], index) => {
            const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : 'ğŸ–ï¸';
            const winRate = data.total > 0 ? ((data.king / data.total) * 100).toFixed(1) : 0;
            
            html += `
                <div class="competition-item">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${medal} ${player}</strong>
                            <div style="font-size: 0.85em; color: #94a3b8; margin-top: 5px;">
                                <span class="user-badge">ğŸ‘‘ ${data.king}</span>
                                <span class="user-badge">ğŸ® ${data.total}</span>
                            </div>
                        </div>
                        <div style="text-align: left;">
                            <div>Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ²: ${winRate}%</div>
                            <div>Ø§Ù„Ø¨Ø¹Ø±ÙˆØ±: ${data.bad}</div>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    document.getElementById('statsBox').innerHTML = html;
};

window.toggleCompare = function() {
    const playerA = document.getElementById('playerA').value;
    const playerB = document.getElementById('playerB').value;
    const element = document.getElementById('compareElement').value;
    
    if (!playerA || !playerB) {
        showToast("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©", "warning");
        return;
    }
    
    if (playerA === playerB) {
        showToast("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù…Ø®ØªÙ„ÙÙŠÙ†", "warning");
        return;
    }
    
    const stats = window.buildStats("all");
    const aStats = stats[playerA] || { total: 0, king: 0, bad: 0 };
    const bStats = stats[playerB] || { total: 0, king: 0, bad: 0 };
    
    const aWinRate = aStats.total > 0 ? ((aStats.king / aStats.total) * 100).toFixed(1) : 0;
    const bWinRate = bStats.total > 0 ? ((bStats.king / bStats.total) * 100).toFixed(1) : 0;
    
    let aValue, bValue;
    switch(element) {
        case 'total': aValue = aStats.total; bValue = bStats.total; break;
        case 'king': aValue = aStats.king; bValue = bStats.king; break;
        case 'bad': aValue = aStats.bad; bValue = bStats.bad; break;
        case 'winRate': aValue = parseFloat(aWinRate); bValue = parseFloat(bWinRate); break;
    }
    
    let winner = "";
    if (aValue > bValue) {
        winner = `${playerA} ÙŠØªÙÙˆÙ‚ Ø¨Ù€ ${(aValue - bValue).toFixed(1)}`;
    } else if (bValue > aValue) {
        winner = `${playerB} ÙŠØªÙÙˆÙ‚ Ø¨Ù€ ${(bValue - aValue).toFixed(1)}`;
    } else {
        winner = "ØªØ¹Ø§Ø¯Ù„";
    }
    
    const compareResult = document.getElementById('compareResult');
    compareResult.innerHTML = `
        <div style="text-align: center;">
            <h4>ğŸ†š Ù…Ù‚Ø§Ø±Ù†Ø©</h4>
            <div style="display: flex; justify-content: space-around; margin: 20px 0;">
                <div style="text-align: center;">
                    <div style="font-size: 2em; font-weight: bold; color: #22c55e;">${aValue}</div>
                    <div style="font-size: 1.1em;">${playerA}</div>
                    <div style="font-size: 0.85em; color: #94a3b8; margin-top: 5px;">
                        ğŸ‘‘ ${aStats.king} | ğŸ¤¡ ${aStats.bad} | ğŸ“Š ${aWinRate}%
                    </div>
                </div>
                <div style="align-self: center; font-size: 1.5em;">VS</div>
                <div style="text-align: center;">
                    <div style="font-size: 2em; font-weight: bold; color: #3b82f6;">${bValue}</div>
                    <div style="font-size: 1.1em;">${playerB}</div>
                    <div style="font-size: 0.85em; color: #94a3b8; margin-top: 5px;">
                        ğŸ‘‘ ${bStats.king} | ğŸ¤¡ ${bStats.bad} | ğŸ“Š ${bWinRate}%
                    </div>
                </div>
            </div>
            <div style="background: #1e293b; padding: 10px; border-radius: 8px; margin-top: 15px;">
                <strong style="color: #fbbf24;">ğŸ† Ø§Ù„Ù†ØªÙŠØ¬Ø©:</strong> ${winner}
            </div>
        </div>
    `;
};

window.showMyStats = function() {
    const myCompetitions = window.competitions.filter(c => c.addedBy === currentUser.username);
    
    let html = `<h4>ğŸ‘¤ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ${currentUser.name}</h4>`;
    
    html += `
        <div class="competition-item">
            <div style="display: flex; justify-content: space-around; text-align: center;">
                <div>
                    <div style="font-size: 1.5em; font-weight: bold; color: #22c55e;">${myCompetitions.length}</div>
                    <div style="font-size: 0.9em; color: #94a3b8;">Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ©</div>
                </div>
            </div>
        </div>
    `;
    
    if (myCompetitions.length > 0) {
        html += '<h5>ğŸ“ Ø¢Ø®Ø± Ø¯ÙˆØ±ÙŠØ§ØªÙŠ:</h5>';
        myCompetitions.slice(0, 5).forEach(comp => {
            html += `
                <div class="competition-item">
                    <div style="margin-bottom: 8px;">
                        <strong>ğŸ‘¥ ${comp.players.join('ØŒ ')}</strong>
                    </div>
                    <div style="font-size: 0.85em; color: #94a3b8;">
                        <span class="time-badge">ğŸ“… ${comp.date}</span>
                        <span class="time-badge">â° ${comp.time}</span>
                    </div>
                </div>
            `;
        });
    }
    
    document.getElementById('statsBox').innerHTML = html;
};

window.showHistory = function() {
    let html = '<h4>ğŸ“œ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª</h4>';
    
    if (window.competitions.length === 0) {
        html += '<p style="color: #94a3b8; text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙˆØ±ÙŠØ§Øª</p>';
    } else {
        window.competitions.forEach(comp => {
            const deleteBtn = (currentUser?.role === "admin") ? 
                `<button class="delete-btn" onclick="deleteCompetition('${comp.id}')" title="Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±ÙŠ">Ã—</button>` : '';
            
            html += `
                <div class="competition-item ${(currentUser?.role === "admin" && deleteMode) ? "admin-visible" : ""}">
                    ${deleteBtn}
                    <div style="margin-bottom: 8px;">
                        <strong>ğŸ‘¥ ${comp.players.join('ØŒ ')}</strong>
                    </div>
                    <div style="font-size: 0.85em;">
                        <span class="user-badge">ğŸ‘¤ ${comp.addedByName}</span>
                        <span class="time-badge">ğŸ“… ${comp.date}</span>
                        <span class="time-badge">â° ${comp.time}</span>
                    </div>
                </div>
            `;
        });
    }
    
    document.getElementById('statsBox').innerHTML = html;
};

// ==================== ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© ====================
function updatePlayersLists() {
    const datalist = document.getElementById('playersDatalist');
    const playerA = document.getElementById('playerA');
    const playerB = document.getElementById('playerB');
    
    window.allPlayers.clear();
    window.competitions.forEach(c => {
        c.players.forEach(p => {
            if (p.includes(" & ")) {
                p.split(" & ").forEach(pl => window.allPlayers.add(pl.trim()));
            } else {
                window.allPlayers.add(p.trim());
            }
        });
    });
    
    datalist.innerHTML = '';
    playerA.innerHTML = '<option value="">ğŸ‘¤ Ø§Ø®ØªØ± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„</option>';
    playerB.innerHTML = '<option value="">ğŸ‘¤ Ø§Ø®ØªØ± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>';
    
    [...window.allPlayers].forEach(player => {
        datalist.innerHTML += `<option value="${player}">`;
        playerA.innerHTML += `<option value="${player}">${player}</option>`;
        playerB.innerHTML += `<option value="${player}">${player}</option>`;
    });
}

function switchMode() {
    const type = document.getElementById('type').value;
    document.getElementById('individualBox').style.display = type === "individual" ? "block" : "none";
    document.getElementById('teamBox').style.display = type === "team" ? "block" : "none";
}

function addIndividual() {
    const div = document.createElement('div');
    div.innerHTML = `<input list="playersDatalist" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨">`;
    document.getElementById('individuals').appendChild(div);
}

function addTeam() {
    const div = document.createElement('div');
    div.innerHTML = `
        <input list="playersDatalist" placeholder="Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„">
        <input list="playersDatalist" placeholder="Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ">
    `;
    document.getElementById('teams').appendChild(div);
}

function clearForm() {
    document.querySelectorAll("#individuals input").forEach(i => i.value = "");
    document.querySelectorAll("#teams input").forEach(i => i.value = "");
    document.getElementById('individuals').innerHTML = '';
    document.getElementById('teams').innerHTML = '';
    addIndividual();
    addIndividual();
}

function refreshData() {
    loadCompetitions();
    showToast("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
}

function quickAddPlayers() {
    const commonPlayers = ['Ø§Ù„Ø¹Ø¨Ø¯Ù„ÙŠ', 'Ù…Ø­Ù…Ø¯', 'Ø£Ø­Ù…Ø¯', 'Ø®Ø§Ù„Ø¯', 'Ø¹Ù…Ø±', 'Ø¹Ù„ÙŠ'];
    const container = document.getElementById('individuals');
    container.innerHTML = '';
    
    commonPlayers.forEach(player => {
        const div = document.createElement('div');
        div.innerHTML = `<input list="playersDatalist" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨" value="${player}">`;
        container.appendChild(div);
    });
}

function showConfirmModal(title, message, callback) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalMessage').textContent = message;
    document.getElementById('confirmModal').style.display = 'flex';
    window.pendingAction = callback;
}

window.confirmAction = function(confirmed) {
    document.getElementById('confirmModal').style.display = 'none';
    if (confirmed && window.pendingAction) window.pendingAction();
    window.pendingAction = null;
};

// ==================== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© ====================
window.showUsersManagement = function() {
    if (currentUser?.role !== "admin") return;
    
    let html = '<h4>ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h4>';
    
    USERS.forEach(user => {
        const userCompetitions = window.competitions.filter(c => c.addedBy === user.u).length;
        html += `
            <div class="competition-item">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${user.n}</strong>
                        <div style="font-size: 0.85em; color: #94a3b8;">
                            ${user.u} | ${user.r === 'admin' ? 'Ø£Ø¯Ù…Ù†' : 'Ù…Ø³ØªØ®Ø¯Ù…'} | Ø¯ÙˆØ±ÙŠØ§Øª: ${userCompetitions}
                        </div>
                    </div>
                    ${user.u !== currentUser.username ? 
                        `<button onclick="deleteUser('${user.u}')" class="danger" style="padding: 5px 10px; font-size: 0.8em;">Ø­Ø°Ù</button>` : 
                        `<span style="color: #94a3b8; font-size: 0.8em;">(Ø£Ù†Øª)</span>`
                    }
                </div>
            </div>
        `;
    });
    
    html += `
        <div style="margin-top: 20px;">
            <input type="text" id="newUserUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯" style="margin-bottom: 10px;">
            <input type="password" id="newUserPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="margin-bottom: 10px;">
            <input type="text" id="newUserName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶" style="margin-bottom: 10px;">
            <select id="newUserRole" style="margin-bottom: 10px;">
                <option value="user">Ù…Ø³ØªØ®Ø¯Ù…</option>
                <option value="admin">Ø£Ø¯Ù…Ù†</option>
            </select>
            <button onclick="addNewUser()" class="secondary">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
        </div>
    `;
    
    document.getElementById('statsBox').innerHTML = html;
};

function deleteUser(username) {
    if (username === currentUser.username) {
        showToast("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø®Ø§Øµ", "error");
        return;
    }
    
    showConfirmModal("Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…", `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${username}"ØŸ`, () => {
        USERS = USERS.filter(u => u.u !== username);
        encryptedStorage.set('users', USERS);
        showToast("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
        showUsersManagement();
    });
}

function addNewUser() {
    const username = document.getElementById('newUserUsername').value.trim();
    const password = document.getElementById('newUserPassword').value;
    const name = document.getElementById('newUserName').value.trim();
    const role = document.getElementById('newUserRole').value;
    
    if (!username || !password || !name) {
        showToast("âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„", "warning");
        return;
    }
    
    if (USERS.find(u => u.u === username)) {
        showToast("âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„", "error");
        return;
    }
    
    USERS.push({ u: username, p: password, n: name, r: role, c: 0 });
    encryptedStorage.set('users', USERS);
    
    document.getElementById('newUserUsername').value = '';
    document.getElementById('newUserPassword').value = '';
    document.getElementById('newUserName').value = '';
    
    showToast(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${name}"`);
    showUsersManagement();
}

window.showPlayersManagement = function() {
    let html = '<h4>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h4>';
    
    const playerStats = {};
    window.competitions.forEach(c => {
        c.players.forEach(p => {
            if (p.includes(" & ")) {
                p.split(" & ").forEach(pl => {
                    const name = pl.trim();
                    playerStats[name] = (playerStats[name] || 0) + 1;
                });
            } else {
                const name = p.trim();
                playerStats[name] = (playerStats[name] || 0) + 1;
            }
        });
    });
    
    const sortedPlayers = Object.entries(playerStats).sort((a, b) => b[1] - a[1]);
    
    if (sortedPlayers.length === 0) {
        html += '<p style="color: #94a3b8; text-align: center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ†</p>';
    } else {
        sortedPlayers.forEach(([player, count]) => {
            html += `
                <div class="competition-item">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>${player}</span>
                        <span class="user-badge">ğŸ® ${count}</span>
                    </div>
                </div>
            `;
        });
    }
    
    document.getElementById('statsBox').innerHTML = html;
};

window.resetAllData = async function() {
    if (currentUser?.role !== "admin") {
        showToast("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØµÙÙŠØ±", "error");
        return;
    }
    
    showConfirmModal("ğŸ”¥ ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", 
        "âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡! ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ù…Ù„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.", 
        async () => {
            try {
                updateSyncStatus("ğŸ”¥ Ø¬Ø§Ø±ÙŠ ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...", "syncing");
                
                // 1. ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                window.competitions = [];
                window.allPlayers.clear();
                window.pendingSync = [];
                encryptedStorage.clear();
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                encryptedStorage.set('users', USERS);
                encryptedStorage.set('competitions', []);
                encryptedStorage.set('pendingSync', []);
                
                // 2. ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØ¹Ù„Ø© ÙˆÙ…ØªØµÙ„Ø©)
                if (window.firebaseEnabled && window.isOnline) {
                    try {
                        const response = await fetch(
                            "https://firestore.googleapis.com/v1/projects/winner-71276/databases/(default)/documents/competitions",
                            { headers: { 'Accept': 'application/json' } }
                        );
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.documents && data.documents.length > 0) {
                                for (const doc of data.documents) {
                                    await fetch(`https://firestore.googleapis.com/v1/${doc.name}`, { 
                                        method: 'DELETE' 
                                    });
                                }
                            }
                        }
                    } catch (cloudError) {
                        console.log("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©:", cloudError.message);
                    }
                }
                
                // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                updateAppStats();
                displayCompetitionsHistory();
                updatePlayersLists();
                
                updateSyncStatus("âœ… ØªÙ… ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "online");
                showToast("âœ… ØªÙ… ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­", "info");
                
            } catch (error) {
                console.error("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµÙÙŠØ±:", error);
                updateSyncStatus("âŒ ÙØ´Ù„ Ø§Ù„ØªØµÙÙŠØ±", "error");
                showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
            }
        }
    );
};

window.showBackupRestore = function() {
    if (currentUser?.role !== "admin") return;
    
    showConfirmModal("Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ", "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙƒØ§Ù…Ù„Ø©ØŸ", () => {
        const backup = {
            competitions: window.competitions,
            users: USERS,
            backupDate: new Date().toLocaleString('ar-SA')
        };
        
        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `kingbad_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©\nğŸ“Š ${window.competitions.length} Ø¯ÙˆØ±ÙŠ`);
    });
};

window.forceSync = function() {
    if (currentUser?.role !== "admin") return;
    
    showConfirmModal("Ù…Ø²Ø§Ù…Ù†Ø© Ù‚Ø³Ø±ÙŠØ©", "Ù‡Ù„ ØªØ±ÙŠØ¯ ÙØ±Ø¶ Ù…Ø²Ø§Ù…Ù†Ø© ÙƒØ§Ù…Ù„Ø© Ù…Ø¹ Ø­Ø°Ù Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§ØªØŸ", async () => {
        updateSyncStatus("âš¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù‚Ø³Ø±ÙŠØ©...", "syncing");
        
        try {
            // Ø±ÙØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
            const localCompetitions = window.competitions;
            const uploaded = [];
            
            for (const comp of localCompetitions) {
                const uploadedSuccess = await syncToCloud(comp);
                if (uploadedSuccess) {
                    uploaded.push(comp);
                }
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
            const cloudData = await loadFromCloud();
            if (cloudData?.competitions) {
                const beforeCount = window.competitions.length;
                smartMergeData(cloudData.competitions);
                const afterCount = window.competitions.length;
                const newCount = afterCount - beforeCount;
                
                showToast(`âœ… ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù‚Ø³Ø±ÙŠØ©\nğŸ“¤ ØªÙ… Ø±ÙØ¹ ${uploaded.length} Ø¯ÙˆØ±ÙŠ\nğŸ“¥ ØªÙ… Ø¥Ø¶Ø§ÙØ© ${newCount} Ø¯ÙˆØ±ÙŠ Ø¬Ø¯ÙŠØ¯`);
            } else {
                showToast(`âœ… ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù‚Ø³Ø±ÙŠØ©\nğŸ“¤ ØªÙ… Ø±ÙØ¹ ${uploaded.length} Ø¯ÙˆØ±ÙŠ`);
            }
            
            updateSyncStatus("âœ… ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù‚Ø³Ø±ÙŠØ©", "online");
            loadCompetitions();
            
        } catch (error) {
            updateSyncStatus("âŒ ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©", "error");
            showToast("âŒ ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù‚Ø³Ø±ÙŠØ©: " + error.message, "error");
        }
    });
};

window.showSyncStats = function() {
    let html = '<h4>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</h4>';
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©
    const duplicates = findDuplicates();
    
    html += `
        <div class="competition-item">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center;">
                <div>
                    <div style="font-size: 1.5em; font-weight: bold; color: #22c55e;">${window.competitions.length}</div>
                    <div style="font-size: 0.9em; color: #94a3b8;">Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª</div>
                </div>
                <div>
                    <div style="font-size: 1.5em; font-weight: bold; color: ${duplicates.length > 0 ? '#ef4444' : '#3b82f6'};">${duplicates.length}</div>
                    <div style="font-size: 0.9em; color: #94a3b8;">ØªÙƒØ±Ø§Ø±Ø§Øª Ù…Ø­ØªÙ…Ù„Ø©</div>
                </div>
            </div>
        </div>
        
        <div class="competition-item">
            <div style="text-align: center;">
                <div style="font-size: 1.2em;">
                    Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø§Ø¨Ø©: <span class="${window.firebaseEnabled ? 'online' : 'offline'}">
                    ${window.firebaseEnabled ? 'ğŸŸ¢ Ù…ÙØ¹Ù‘Ù„Ø©' : 'ğŸ”´ Ù…Ø¹Ø·Ù„Ø©'}
                    </span>
                </div>
                <div style="font-size: 0.9em; color: #94a3b8; margin-top: 5px;">
                    Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©: ${window.lastSyncTime ? window.lastSyncTime.toLocaleString('ar-SA') : 'Ù„Ù… ØªØªÙ…'}
                </div>
            </div>
        </div>
    `;
    
    // Ø¹Ø±Ø¶ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
    if (duplicates.length > 0) {
        html += '<h5 style="margin-top: 15px; color: #ef4444;">ğŸ” Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©:</h5>';
        duplicates.forEach((dup, index) => {
            html += `
                <div class="competition-item" style="border-right-color: #ef4444;">
                    <div style="margin-bottom: 8px;">
                        <strong>${index + 1}. ${dup.players.join('ØŒ ')}</strong>
                    </div>
                    <div style="font-size: 0.85em; color: #94a3b8;">
                        <span class="time-badge">ğŸ“… ${dup.date}</span>
                        <span class="time-badge">ğŸ‘¤ ${dup.addedByName}</span>
                        <span class="time-badge">ğŸ”„ ${dup.occurrences} ØªÙƒØ±Ø§Ø±</span>
                    </div>
                </div>
            `;
        });
        
        html += `
            <div style="margin-top: 15px;">
                <button onclick="removeDuplicates()" class="danger" style="width: 100%;">ğŸ—‘ï¸ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª</button>
            </div>
        `;
    }
    
    document.getElementById('statsBox').innerHTML = html;
};

function findDuplicates() {
    const seen = new Map();
    const duplicates = [];
    
    window.competitions.forEach(comp => {
        const key = createCompetitionKey(comp);
        if (seen.has(key)) {
            const existing = duplicates.find(d => d.key === key);
            if (existing) {
                existing.occurrences++;
            } else {
                duplicates.push({
                    key: key,
                    players: comp.players,
                    date: comp.date,
                    addedByName: comp.addedByName,
                    occurrences: 2
                });
            }
        } else {
            seen.set(key, comp);
        }
    });
    
    return duplicates;
}

window.removeDuplicates = function() {
    if (currentUser?.role !== "admin") {
        showToast("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª", "error");
        return;
    }
    
    showConfirmModal("Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª", "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ", () => {
        const uniqueMap = new Map();
        const uniqueCompetitions = [];
        let removedCount = 0;
        
        // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø© Ù…Ù† ÙƒÙ„ Ø¯ÙˆØ±ÙŠ
        window.competitions.forEach(comp => {
            const key = createCompetitionKey(comp);
            const existing = uniqueMap.get(key);
            
            if (existing) {
                // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø£Ø­Ø¯Ø« (Ø£Ø­Ø¯Ø« timestamp)
                if (new Date(comp.timestamp) > new Date(existing.timestamp)) {
                    uniqueMap.set(key, comp);
                }
                removedCount++;
            } else {
                uniqueMap.set(key, comp);
            }
        });
        
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ©
        uniqueCompetitions.push(...uniqueMap.values());
        
        // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
        uniqueCompetitions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        window.competitions = uniqueCompetitions;
        encryptedStorage.set('competitions', window.competitions);
        
        updateAppStats();
        displayCompetitionsHistory();
        updatePlayersLists();
        
        showToast(`âœ… ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© ${removedCount} Ø¯ÙˆØ±ÙŠ Ù…ÙƒØ±Ø±\nâœ… Ø¨Ù‚ÙŠ ${window.competitions.length} Ø¯ÙˆØ±ÙŠ ÙØ±ÙŠØ¯`);
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
        showSyncStats();
    });
};

// ==================== Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø°ÙƒÙŠØ© ====================
window.syncData = async function() {
    updateSyncStatus("ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø°ÙƒÙŠØ©...", "syncing");
    
    try {
        // 1. Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
        await syncPendingData();
        
        // 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
        const cloudData = await loadFromCloud();
        if (cloudData?.competitions) {
            const beforeCount = window.competitions.length;
            const newCount = smartMergeData(cloudData.competitions);
            
            if (newCount > 0) {
                updateAppStats();
                displayCompetitionsHistory();
                updatePlayersLists();
                showToast(`âœ… ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ØªÙ… Ø¥Ø¶Ø§ÙØ© ${newCount} Ø¯ÙˆØ±ÙŠ Ø¬Ø¯ÙŠØ¯`);
            } else {
                showToast("âœ… ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©");
            }
        } else {
            showToast("âœ… ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©");
        }
        
        updateSyncStatus("âœ… ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø°ÙƒÙŠØ©", "online");
        
    } catch (error) {
        updateSyncStatus("âŒ ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©", "error");
        showToast("âŒ ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: " + error.message, "error");
    }
};

// ==================== Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ====================
window.onload = function() {
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    const savedUsers = encryptedStorage.get('users');
    if (savedUsers) {
        USERS = savedUsers;
    }
    
    const savedUser = encryptedStorage.get('currentUser');
    if (savedUser) {
        window.currentUser = savedUser;
        updateUserInterface();
        document.getElementById('loginBox').style.display = "none";
        document.getElementById('appBox').style.display = "block";
        loadCompetitions();
    }
    
    addIndividual();
    addIndividual();
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    window.addEventListener('online', () => {
        window.isOnline = true;
        updateSyncStatus("ğŸŸ¢ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª", "online");
        if (window.pendingSync.length > 0) {
            setTimeout(() => syncPendingData(), 1000);
        }
    });
    
    window.addEventListener('offline', () => {
        window.isOnline = false;
        updateSyncStatus("ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„", "offline");
    });
    
    if (navigator.onLine) {
        updateSyncStatus("ğŸŸ¢ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©", "online");
    } else {
        updateSyncStatus("ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„", "offline");
    }
};
</script>
</body>
</html>